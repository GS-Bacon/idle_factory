# 作業ログ

## 2025-12-30
- **P0/P1タスク完了**
  - 入力ハンドラー状態チェック統一: player_look, furnace_interact, crusher_interact, inventory_toggle
  - 全ハンドラーで入力マトリクス（inventory_open, interacting_furnace, interacting_crusher, command_state, cursor_state.paused）を正しくチェック
  - 未使用コード削除: InputState::allows_camera()を削除
  - pre-commit強化: cargo build + test + clippyを自動実行
  - game_spec.rs: 初期装備・クエストのコメント更新（クイックスタートモード）
  - テスト69件成功、clippy警告なし
- **整合性チェックテスト追加**
  - 仕様と実装の矛盾を自動検出するテスト7件追加
  - test_hotbar_scroll_stays_in_bounds: ホイール範囲チェック
  - test_inventory_consumption_mechanism: モード別消費チェック
  - test_mode_constants_consistency: 定数整合性
  - test_inventory_slot_indices_consistency: スロット範囲
  - test_block_type_consistency: ブロックタイプ整合性
  - test_quest_rewards_consistency: クエスト報酬
  - test_initial_game_state_consistency: 初期状態
- **バグ修正（BUG-8, BUG-9）**
  - サバイバルモードでクリエイティブUIが表示される問題を修正
  - インベントリUI内クリックでカーソルが消える問題を修正
  - CreativePanelマーカーコンポーネント追加
  - web/index.htmlのcanvasクリックハンドラーにUI状態チェック追加
- **入力ハンドラー修正**
  - select_block_type: ホイールをHOTBAR_SLOTS範囲に制限、command_stateチェック追加
  - quest_claim_rewards: command_stateチェック追加
- **WASM修正**
  - RuntimeError: unreachableを修正（LogPlugin無効化）
  - キャッシュバスティング追加（.js/.wasmファイル）
- **テスト**: 69件成功、clippy警告なし
- **連続操作機能追加**
  - Shift+左クリック押しっぱなしでインベントリ連続移動
  - 左クリック押しっぱなしでブロック連続破壊
  - 右クリック押しっぱなしでブロック連続設置
  - ContinuousActionTimerリソースで0.15秒間隔を制御
- **ホットバーアイテム名表示**
  - ホットバー選択中のアイテム名を上部に表示
  - HotbarItemNameText、update_hotbar_item_name追加
- **インベントリツールチップ**
  - スロットホバー時にアイテム名と数量を表示
  - InventoryTooltip、update_inventory_tooltip追加
- **クリエイティブモード統一**
  - F-keyショートカットを削除（カタログのみに統一）
  - /creative、/survivalコマンドでモード切替
  - Eキーでインベントリ+カタログ表示
- **システムパラメータ最適化**
  - MachineBreakQueries、MachinePlaceQueries SystemParam追加
  - block_break、block_placeのパラメータ数を17→14に削減
  - Bevyの16パラメータ制限を回避
- **インベントリUI改善（マイクラ風）**
  - HeldItemDisplayをカーソル追従に（update_held_item_display追加）
  - 持っているアイテムをカーソル位置に表示、数量テキスト付き
  - インベントリ閉じる時にHeldItemをインベントリに自動返却
  - player_moveにInventoryOpen、InteractingCrusher、CommandInputStateチェック追加
  - select_block_typeにInventoryOpenチェック追加（UI表示中はホイール無効）
  - HeldItemText、return_held_item_to_inventory追加
  - Inventory::add_itemの戻り値をbool→u32に変更（残量を返す）
  - 69ユニットテスト成功、clippy警告なし
- **バグ修正3件（BUG-15,16,17）**
  - コンベア分岐設置不可: auto_conveyor_directionのPriority 3を削除
  - 機械UI ESC後クリック必要: furnace_interact/crusher_interactでcursor_state.paused=true設定
  - クリエイティブホバー表示なし: update_inventory_tooltipにCreativeItemButtonクエリ追加
- **post-commit hook改善**
  - WASMビルド＆デプロイを自動実行（バックグラウンド）
  - デプロイ完了/失敗をDiscord通知
- **コンベア設置方向回転**
  - Rキーでコンベア設置方向を90度回転
  - ConveyorRotationOffset リソース追加
  - Direction::rotate_cw() メソッド追加

## 2025-12-29
- **ロギングシステム簡素化**
  - GameLogBuffer, LogEntry, 未使用マクロを削除
  - logging.rsを43行に簡素化（157行→43行）
  - run.shにログファイル出力を追加（logs/game_YYYYMMDD_HHMMSS.log）
  - capture-wasm-logs.js: WASM版のブラウザコンソールキャプチャ
  - show-logs.sh: ログ確認ヘルパースクリプト
  - CLAUDE.mdの「バグ修正の手順」をAI主導のログ収集に更新
  - テスト81件成功、clippy警告なし
- **コンベア複数アイテム対応**
  - ConveyorItem構造体を追加（block_type, progress, visual_entity）
  - 1コンベアあたり最大3アイテム（CONVEYOR_MAX_ITEMS定数）
  - アイテム間の最小間隔0.33（CONVEYOR_ITEM_SPACING定数）
  - conveyor_transferを大幅リファクタリング（2フェーズ処理でborrow競合回避）
- **コンベア途中合流対応**
  - Conveyor::get_join_progress()メソッド追加
  - 側面（垂直）からの合流はprogress=0.5から開始
  - 後方からの合流はprogress=0.0から開始
  - miner_output, crusher_output, furnace_output, conveyor_transferを更新
- **納品アニメーション改善**
  - アイテムがprogress=1.0（コンベア端）に到達してから納品
  - 途中で消えず、最後まで流れてから納品
- **コンベア用ワイヤーフレーム（向き矢印付き）**
  - create_conveyor_wireframe_mesh(direction)関数追加
  - 矢印で方向を表示
  - コンベア設置時は設置予定の向きを表示
  - 既存コンベア選択時は実際の向きを表示
- **その他の改善**
  - Inventory::get_selected_type()メソッド追加
  - update_target_highlightにコンベア検出を追加
  - constants.rsにCONVEYOR_MAX_ITEMS, CONVEYOR_ITEM_SPACING追加
- **テスト**: 40テスト成功、clippy警告なし
- **フェーズ1: バグ修正（BUG-3,4,5）**
  - BUG-3: 転送時にvisual_entityを引き継ぎ、ちらつき解消
  - BUG-4: アイテムサイズ0.4→0.25、間隔0.33→0.4に調整
  - BUG-5: lateral_offset導入でスムーズな横合流アニメーション
  - ConveyorItem構造体にlateral_offsetフィールド追加
  - get_join_info()メソッド追加（progress, lateral_offset両方返す）
  - update_conveyor_item_visualsでlateral_vec計算を追加
- **フェーズ6: テスト改善**
  - test_conveyor_item_no_overlap追加
  - test_conveyor_side_merge_offset追加
  - test_inventory_stack_limit_999追加
  - test_multiple_conveyor_merge追加
  - test_conveyor_loop_handling追加
  - test_entity_count_stability追加
  - test_visual_entity_handoff追加
  - テスト総数: 59件（12ユニット + 47 E2E）
- **フェーズ7: モジュール分割・イベント駆動化**
  - player/inventory.rs: Inventory構造体を分離（117行）
  - events/mod.rs: イベント構造体とGameEventsPluginを定義（67行）
  - BlockPlaceEvent, BlockBreakEvent, MachineInteractEvent等
  - main.rs: 5246行→5136行（110行削減）
- **ログシステム改善**
  - logging.rs: GameLoggingPlugin, GameLogBuffer追加
  - tracing crateでRust側の構造化ログ
  - BLOCK/MACHINE/QUESTカテゴリでログ分類
  - 主要操作にinfo!ログ追加（block_break, block_place, 機械設置/破壊, 納品）
  - WASM: ブラウザコンソールでログ確認可能
    - showGameLogs() - ログ一覧
    - filterLogs('MACHINE') - カテゴリフィルタ
    - recentLogs(20) - 直近N件
- **フェーズ3: コンベア改善**
  - 細いベルト形状（0.6幅 x 0.2高）
  - CONVEYOR_BELT_WIDTH, CONVEYOR_BELT_HEIGHT定数追加
  - アイテム位置をベルト上面に調整
  - 設置向き自動判断（auto_conveyor_direction関数）
    - 隣接コンベアの向きを継続
    - 隣接機械から離れる方向
    - フォールバック: プレイヤーの向き
  - スプリッター/ジッパー用ステート（last_output_index, last_input_source）追加
- **フェーズ4: インベントリ改善**
  - 36スロット（ホットバー9 + メイン27）
  - HOTBAR_SLOTS, MAIN_INVENTORY_SLOTS, MAX_STACK_SIZE定数追加
  - 999スタック上限対応
  - move_itemsメソッド追加（スワップ/スタック対応）
  - is_hotbar_slot, is_main_slotヘルパー追加
- **テスト**: 47件成功、clippy警告なし
- **ツール追加**
  - discord-notify.sh: Discord Webhook通知スクリプト

## 2025-12-28
- **ESC後のカメラ操作無効化を修正**
  - CursorLockStateに`paused`フラグを追加
  - ESC押下時にpaused=true、クリック復帰時にpaused=false
  - player_look, player_move, block_break, block_place, update_target_blockでpausedチェック
  - "Click to Resume"表示中は全ての操作が無効になるように
- **レイキャスト精度をDDAアルゴリズムに改善**
  - 0.5ブロックステップの粗いレイキャストからDDA（Digital Differential Analyzer）に変更
  - ボクセル単位で正確に通過ブロックをチェック
  - 下のブロックを貫通して破壊できる問題を修正
  - update_target_block, block_break, block_placeの3箇所を更新
- **デバッグHUDにモード表示を追加**
  - F3でCreative/Survivalモードを表示
  - [PAUSED]表示を追加
- **クリエイティブモードUI改善**
  - Cキーでクリエイティブモード有効時、全9スロットに各アイテム64個を自動付与
  - クリエイティブモードではブロック設置時にインベントリを消費しない
  - F1-F9は現在のスロットのアイテムを変更するように変更
- **ターゲットブロックハイライト追加**
  - プレイヤーが見ているブロックに赤い半透明キューブを表示
  - 破壊対象が視覚的にわかるように
- **クリエイティブモード追加**
  - Cキーでトグル
  - F1-F10で各種アイテムを64個取得
  - Stone, Grass, IronOre, Coal, IronIngot, CopperOre, CopperIngot, Miner, Conveyor, Crusher
- **ESC処理の再修正**
  - ESCでUIを閉じた時はカーソルをアンロック（ブラウザの状態と一致）
  - Eキーでの閉じはロック維持
  - カメラ操作がロック状態に正しく連動
- **CHUNK_HEIGHTを8→32に拡大**
  - 地面の上にブロックを積めるように修正
  - GROUND_LEVEL定数を追加（Y=7）
  - 地下はY=0-6、地面はY=7、上空はY=8-31
- **Pointer Lockとカメラ操作を改善**
  - ESCでUIを閉じた後にポインターロックを再取得
  - JavaScript側で100ms遅延を入れてオーバーレイ表示を制御
  - RDPフォールバックを削除し、シンプルなdeltaクランプ方式に変更
  - MAX_DELTA=100.0で高速マウス移動時のジャンプを防止
- **E2Eテスト大幅拡充（30→52テスト）**
  - 機械コンポーネントテスト: Miner, Conveyor, Furnace, Crusher
  - エンティティクリーンアップテスト: コンベア破壊時のアイテム残留検出
  - クエスト・納品プラットフォームテスト
  - チャンク境界メッシュテスト
  - 自動化ライン統合テスト（Miner→Conv→Crusher→Conv→Furnace→Conv→Delivery）
  - レイキャスト全機械タイプテスト
- **CLAUDE.md「よくあるバグと対策」拡張**
  - 6つのバグパターンをドキュメント化
  - 実装時のチェックリスト追加
  - 過去の失敗から学習し、同じバグを再発させない仕組み
- **インベントリをスロットベースに完全リファクタリング**
  - HashMap方式から固定9スロット配列に変更
  - `add_item`, `consume_selected`, `consume_item`, `get_slot`, `get_slot_count`メソッド実装
  - スロットが空になっても自動補充されなくなった（バグ修正）
  - 空スロット選択時も位置を維持
- **E2Eテスト拡充（18テスト）**
  - スロットベースインベントリのテスト6件追加
  - `test_slot_inventory_add_stacks`
  - `test_slot_inventory_consume_selected`
  - `test_slot_inventory_empty_slot_stays_selected`
  - `test_slot_inventory_consume_specific_item`
  - `test_slot_inventory_full`
  - `test_slot_inventory_selection_with_empty_slots`
- **OGP設定追加**
  - Open Graph / Twitterカードメタタグ追加
  - ゲームスクリーンショットをOGP画像として使用（ogp.png）
  - ファビコン追加（絵文字SVG）
- **Pointer Lock API対応改善**
  - ESC後のマウス挙動問題を修正
  - オーバーレイ追加（「Click to Resume」表示）
  - pointerlockchange/pointerlockerrorイベント対応
  - 冗長なexitPointerLock()呼び出しを削除
- **エラーハンドリング改善**
  - unwrap()をis_none_or/let elseパターンに置換
  - レイキャスト判定（block_break, block_place, furnace_interaction）
  - 精錬炉/粉砕機処理（furnace_smelting, crusher_processing, crusher_output）
  - clippy警告ゼロ、テスト30件成功（ユニット12 + E2E18）
- **設定ファイル外出し見送り**
  - WASMではファイルシステムアクセスが制限される
  - 現状のconstants.rsで十分機能
- **クリエイティブインベントリUIを実装（マイクラ風）**
  - Cキーでクリエイティブモード → Eキーでインベントリ画面を開く
  - 全11種類のアイテムがグリッド表示（70x70pxボタン）
  - クリックで選択スロットに64個追加
  - ホバー/クリック時の視覚フィードバック
  - ESCで閉じる
- **精錬炉UIをスロットベース＆クリック操作に改善**
  - テキストベース → 3スロット（燃料/入力/出力）のクリックUI
  - プログレスバーで精錬進捗を視覚的に表示
  - キー操作（1,2,3,4キー）不要に
  - UIを開くとカーソルが解放される
- **粉砕機UIを新規追加（精錬炉と同様のスロットUI）**
  - InteractingCrusherリソース、CrusherUIコンポーネント追加
  - 入力/出力の2スロット（燃料なし）
  - Eキーで粉砕機を見てUIを開く
  - クリックで鉱石を追加/取り出し
  - crusher_interact, crusher_ui_input, update_crusher_uiシステム追加
- **40テスト成功、clippy警告ゼロ**

## 2025-12-27
- **ワインディング順序の修正（パフォーマンス向上）**
  - 全6面の頂点順序をCCW（反時計回り）に修正
  - `double_sided: true, cull_mode: None`を削除（4箇所）
  - バックフェースカリング有効化でGPU負荷半減
- **E2Eテスト拡充**
  - ホットバー選択テスト追加
  - ブロック設置によるインベントリ消費テスト追加
  - UI開閉テスト追加（Eキー/ESCキー）
  - フレーム安定性テスト追加（100フレームシミュレーション）
  - ブロック破壊の連続実行テスト追加
  - テスト総数: 11 → 23（ユニット11 + E2E12）
- **cargo clippy警告を全て解消**
  - 未使用メソッド（`index_to_pos`, `has_block_at`, `is_machine`, `can_add_input`）に`#[allow(dead_code)]`追加
  - Range::containsへのリファクタリング（6箇所）
  - `#[allow(clippy::too_many_arguments)]`追加（`player_look`, `block_break`）
- **3つのバグを修正**
  - ブロック設置時のフリーズ: block_placeのchunk再生成パターンをblock_breakと統一
  - 採掘機の視覚的フィードバック: miner_visual_feedbackシステム追加（パルスアニメーション）
  - デフォルト機械の破壊: block_breakにCrusher/Furnaceのレイキャスト追加
- **機械設置時の透ける問題を修正（再修正）**
  - 原因: 機械設置時に`set_block(place_pos, BlockType::Stone)`で偽の石ブロックを登録していた
  - 修正: 機械（Miner, Conveyor, Crusher）設置時は`set_block`を呼ばない
  - 機械は独自エンティティなのでワールドデータ登録不要
- **block_placeのマテリアル設定を統一**
  - `StandardMaterial::default()`を使用していた箇所を修正
  - `double_sided: true, cull_mode: None`に統一
- **カメラ回転の滑らかさ改善**
  - 原因: `MAX_REASONABLE_DELTA = 200.0`が低すぎて高速マウス移動がフィルタリングされていた
  - 修正: `MAX_REASONABLE_DELTA = 500.0`に変更
- **バグ修正3件**
  - 空スロット(8,9)を数字キーで選択可能に（選択解除として動作）
  - 機械設置時の地面透け問題を修正（WorldDataにブロック登録してチャンク再生成）
  - 採掘機を無限資源生成に変更（地面を掘らず、下のブロックタイプに応じて資源生成）
- **ビルド最適化（80コア環境）**
  - sccache導入でコンパイルキャッシュ
  - moldリンカーで高速リンク
  - codegen-units=16で並列コード生成
  - ネイティブ: 2分5秒→55秒、WASM: 2分13秒→7秒
- **ブロック掘削後の透ける問題を修正**
  - ~~両面レンダリング（double_sided: true, cull_mode: None）で対処~~
  - ワインディング順序を修正し、バックフェースカリング再有効化済み（上記参照）
- **チャンク生成パフォーマンス改善**
  - ChunkData: HashMapから配列ベースの実装に変更
  - メッシュ生成: Y-Z-Xループ順でキャッシュ効率向上
  - 事前メモリ割り当て: Vec::with_capacity使用
  - VIEW_DISTANCE: ネイティブ2→3、WASM1→2に増加
  - フレームあたりのチャンク生成数: 2→4に増加
  - CHUNK_HEIGHT定数を追加（8固定）
- **WASM対応を準備**
  - Cargo.tomlにWASM用条件付き依存関係を追加
  - main.rsでPipelinedRenderingPluginを条件付きコンパイル
  - .cargo/config.tomlにgetrandom設定
  - web/index.html、build-wasm.shを作成
  - WASMビルド成功（wasm-bindgenはローカルで実行必要）

## 2025-12-26
- **クエストシステムを実装**
  - QuestDef: 目標アイテム、必要数、報酬を定義
  - CurrentQuestリソース: 進捗状態を管理
  - Quest 1: 鉄インゴット3個納品 → 採掘機×2, コンベア×20
  - Quest 2: 鉄インゴット100個納品 → 採掘機×2, コンベア×40
  - 画面上部中央にクエストUI表示
  - Q キーで報酬受け取り
  - 全15テスト成功
- **納品プラットフォームを実装**
  - DeliveryPlatformコンポーネント（delivered: HashMap<BlockType, u32>）
  - 12×12の緑色プラットフォーム（位置: 20,8,10）
  - 16個の黄色ポートマーカー（辺に4個ずつ）
  - コンベアからアイテム受け取りロジック
  - 右上に納品数UIを表示
  - 全15テスト成功
- **採掘機・コンベアの設置機能を実装**
  - BlockType: MinerBlock, ConveyorBlock追加
  - block_place: 機械設置に対応（Miner, Conveyorコンポーネント自動付与）
  - yaw_to_direction: プレイヤー視線→コンベア向き変換
  - 初期インベントリ: 採掘機×3, コンベア×10追加
  - 右クリックで向いている方向にコンベアを設置
- **採掘機・コンベアを実装**
  - Minerコンポーネント（position, progress, buffer）
  - Conveyorコンポーネント（position, direction, item, progress）
  - Direction列挙型（North, South, East, West）
  - miner_mining: 5秒ごとに下のブロックを採掘、バッファに保持
  - miner_output: 隣接コンベアにアイテム出力
  - conveyor_transfer: コンベアチェーンでアイテム移動、精錬炉に自動投入
  - デモ配置: Miner(5,8,15) → Conv(6,8,15) → Conv(7,8,15) → Furnace(8,8,15)
  - 全15テスト成功
- **精錬炉を実装**
  - BlockType: IronOre, Coal, IronIngot追加
  - Furnaceコンポーネント（fuel, input, output, progress）
  - 初期アイテム（鉄鉱石×5, 石炭×5）
  - Eキーで精錬炉UI表示（見ている精錬炉をターゲット）
  - 精錬ロジック（3秒で1個精錬、燃料+原料→鉄インゴット）
  - 進捗バー付きUI
- **複数チャンク対応を実装**
  - `WorldData`リソースで複数チャンクを管理
  - プレイヤー周囲5x5チャンク（VIEW_DISTANCE=2）を動的ロード/アンロード
  - 座標変換（ワールド↔チャンク↔ローカル）
  - テスト10件追加、全15件パス
- **run.sh修正**
  - パスを`/home/bacon/idle_factory`に修正
  - Xvfb自動検出を追加
  - `source ~/.cargo/env`を追加
- **libxkbcommon-x11-0インストール**（Bevy起動に必要）
