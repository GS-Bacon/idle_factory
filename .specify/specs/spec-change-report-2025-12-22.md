# 仕様変更レポート

**日付**: 2025-12-22
**根拠**: デザインパターン集（52パターン）および調査レポート

---

## 変更サマリー

| 変更区分 | 件数 | 影響範囲 |
|---------|------|----------|
| 新規追加 | 8 | ゲーム・エディタ両方 |
| 拡張 | 5 | 既存仕様の詳細化 |
| 明確化 | 3 | 曖昧な部分の具体化 |

---

## 1. 新規追加

### 1.1 サウンドシステム仕様
**パターン**: S1-S4
**変更先**: `constitution.md`（User Experience Principles）

```yaml
追加内容:
  ミキシング階層: Master > Music/SFX/Voice
  反復疲労防止: 頻出音に3+バリエーション、ピッチ±10%
  空間オーディオ: 距離減衰、近い順N個再生
  カテゴリ別ボリューム: 必須オプション
```

**理由**: 調査で工場ゲームにおける「機械カオス」「警告音疲労」が重大問題と判明。既存仕様に音声設計がなく、実装指針が必要。

---

### 1.2 アクセシビリティ拡張
**パターン**: A1-A3
**変更先**: `constitution.md`（User Experience Principles）、`core-game-mechanics.md`

```yaml
追加内容:
  視覚:
    - 色覚モード（P型/D型/T型）
    - コントラスト比4.5:1以上
    - 色+形状による情報伝達
  聴覚:
    - 字幕オプション
    - 視覚的音響表示（方向インジケーター）
  運動:
    - 全キーリマップ可能
    - ホールド/トグル切替
```

**理由**: 既存は「colorblind-friendly UI」のみ。WCAG基準および競合ゲーム調査から具体的要件を追加。矛盾なし（既存方針の具体化）。

---

### 1.3 ローカライズ対応
**パターン**: I1-I2
**変更先**: `constitution.md`（新セクション）

```yaml
追加内容:
  文字列外部化: 全UI文字列をfluent/i18nで管理
  レイアウト余白: テキスト拡張30%考慮
  RTL準備: 将来の右から左言語対応
```

**理由**: 既存仕様にローカライズ言及なし。Steam配布を考慮すると多言語対応の基盤が必要。

---

### 1.4 セーブデータ暗号化
**パターン**: C3
**変更先**: `constitution.md`（Security & Safety）

```yaml
追加内容:
  暗号化: AES-256-GCM
  用途: セーブデータ、統計データ
  理由: チート防止（シングルプレイ実績保護）
```

**理由**: 既存は「Version checking and migration」のみ。Steam実績システム導入により、セーブ改ざん防止が必要。

---

### 1.5 UI応答時間要件
**パターン**: U2
**変更先**: `constitution.md`（User Experience Principles）

```yaml
追加内容:
  応答時間: 全操作に0.1秒以内のフィードバック
  フィードバック: 視覚+音声の両方推奨
```

**理由**: 既存は「Visual feedback for machine state」のみ。UX調査から具体的な応答時間基準を追加。

---

### 1.6 レシピ設計ガイドライン
**パターン**: R1-R4
**変更先**: `core-game-mechanics.md`（新セクション）

```yaml
追加内容:
  入出力バランス: 副産物に必ず消費先
  比率美学: 整数比優先（計算しやすい）
  深さ制限: 最大5階層
  視認性: ツリー表示、逆引き可能
```

**理由**: 既存はレシピフォーマットのみ。設計指針がないと副産物詰まり等の問題が発生。

---

### 1.7 進行フェーズ設計
**パターン**: P1-P4, L1-L3
**変更先**: `core-game-mechanics.md`（新セクション）

```yaml
追加内容:
  フェーズ構成:
    Phase 1: 学習期（0-2時間）- 手動操作、基本自動化
    Phase 2: 戦略期（2-10時間）- 生産ライン構築
    Phase 3: 拡張期（10-50時間）- 大規模工場
    Phase 4: マスタリー（50時間+）- 最適化、創造的表現
  待機時間: 代替タスク（探索/最適化/計画）を常に用意
  マイルストーン: 各フェーズに明確な達成目標
```

**理由**: 既存は「Space Station Completion」のみ。Factorio/Satisfactory調査から段階的進行設計が重要と判明。

---

### 1.8 テスト戦略拡張
**パターン**: T1-T4
**変更先**: `constitution.md`（Testing Standards）

```yaml
追加内容:
  スナップショットテスト: UI回帰防止（insta）
  ファズテスト: 境界値検証（cargo-fuzz）
  プロパティテスト: 不変条件検証（proptest）
  シミュレーションテスト: 長時間安定性（加速実行）
```

**理由**: 既存は「Unit/Integration/Simulation」のみ。ゲーム特有のテスト手法を追加。

---

## 2. 拡張（既存仕様の詳細化）

### 2.1 エディタUX原則
**パターン**: E1-E6
**変更先**: `steam-editor-mode.md`

```yaml
追加内容:
  即時プレビュー: 編集→即反映（リアルタイム更新）
  非破壊編集: Undo 100+ステップ、履歴ブランチ
  制約視覚化: 有効/無効領域の明示
  スマートデフォルト: コンテキスト依存の初期値
  一括操作: 複数選択→同時編集
  参照整合性: 削除時に使用箇所警告
```

**理由**: 既存は機能のみ。Unity/Blender調査からUX原則を追加。

---

### 2.2 マルチプレイヤー詳細
**パターン**: N1-N4
**変更先**: `constitution.md`（Multiplayer）

```yaml
追加内容:
  入力検証: 速度/範囲/レート制限
  再接続処理: セッション維持、フル同期
  帯域最適化: 差分圧縮、Interest Management
```

**理由**: 既存は「Authoritative server, Client Prediction」のみ。実装時の詳細指針を追加。

---

### 2.3 MODサンドボックス強化
**パターン**: M2
**変更先**: `constitution.md`または`steam-editor-mode.md`

```yaml
追加内容:
  Lua制限: os/io/load/require/dofile無効化
  リソース制限: メモリ64MB、CPU 1ms/tick
  API境界: 明確なpublic API定義
```

**理由**: 既存Luaサンドボックスは実装済みだが、仕様書に明記されていない。

---

### 2.4 グラフィック最適化要件
**パターン**: G1-G4
**変更先**: `constitution.md`（Performance Requirements）

```yaml
追加内容:
  描画コール: 500以下/フレーム
  シェーダー: プリコンパイル必須（スタッター防止）
  オクルージョン: フラスタム+基本オクルージョン（明記）
```

**理由**: 既存は「60 FPS, Instanced rendering」のみ。具体的な数値目標を追加。

---

### 2.5 MOD APIバージョニング
**パターン**: M3
**変更先**: `steam-editor-mode.md`

```yaml
追加内容:
  バージョニング: SemVer（Major.Minor.Patch）
  非推奨化: 1バージョン猶予後に削除
  マイグレーション: 自動変換パス提供
```

**理由**: 既存MODシステムにバージョニングポリシーがない。

---

## 3. 明確化（曖昧な部分の具体化）

### 3.1 「Colorblind-friendly」の具体化
**変更前**: "Accessibility: Rebindable keys, colorblind-friendly UI"
**変更後**: 上記アクセシビリティ仕様（1.2参照）

---

### 3.2 「Audio feedback」の具体化
**変更前**: "Sound Design: Audio feedback for actions"
**変更後**: 上記サウンドシステム仕様（1.1参照）

---

### 3.3 「Save Files」の具体化
**変更前**: "Save Files: Version checking and migration support"
**変更後**: "Save Files: Version checking, migration support, AES-256-GCM encryption"

---

## 矛盾チェック

| 項目 | 既存仕様 | 変更内容 | 矛盾 |
|------|---------|---------|------|
| FPS目標 | 60 FPS | 変更なし | なし |
| チャンクサイズ | 32³ | 変更なし | なし |
| サバイバル要素 | なし | 変更なし | なし |
| ECSアーキテクチャ | 必須 | 変更なし | なし |
| YAML駆動 | 必須 | 変更なし | なし |
| MOD構造 | profiles/mods/ | 変更なし | なし |
| Luaサンドボックス | 実装済み | 仕様明記 | なし（整合） |

---

## 実装優先度

### 必須（リリース前）
1. UI応答時間（U2）- 体感品質に直結
2. アクセシビリティ基本（A1-A3）- 必須オプション
3. セーブ暗号化（C3）- Steam実績保護

### 推奨
4. サウンドシステム（S1-S4）
5. 進行フェーズ設計（P1-P4, L1-L3）
6. レシピ設計ガイドライン（R1-R4）
7. エディタUX（E1-E6）

### 将来
8. ローカライズ（I1-I2）
9. 高度なテスト戦略（T1-T4）
10. MODバージョニング（M3）

---

*このレポートはデザインパターンと既存仕様の照合に基づいています。*
