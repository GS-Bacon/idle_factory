# Research: Resource Networks

**Feature**: リソースネットワーク（電力・流体・信号）
**Date**: 2026-01-30

## Overview

本機能では、電力ネットワーク（発電機→電線→機械）、流体ネットワーク（ポンプ→パイプ→タンク→機械）、信号ネットワーク（センサー→信号線→レシーバー/論理ゲート）の3つのネットワークシステムを実装する。各ネットワークは共通の`NetworkGraph<K, V>`を活用し、独立して動作する。

## Research Topics

### 1. 共通ネットワーク基盤の活用

**問題**: 3つの異なるネットワーク（電力、流体、信号）を効率的に実装する必要がある。各ネットワークは似たようなグラフ構造を持つが、異なるデータを扱う。

**調査事項**:
- 既存の `NetworkGraph<K, V>` が3つのネットワークすべてに適用可能か
- 各ネットワーク固有のデータ構造をどう設計するか
- ネットワークの分離・結合をどう管理するか

**決定**: `NetworkGraph<K, V>` を汎用基盤として使用、各ネットワークは固有のComponent定義

**根拠**:
- **既存コード**: `src/core/network.rs` に `NetworkGraph<K, V>` が実装済み
- **汎用性**: `PowerNetwork = NetworkGraph<u64, f32>`, `FluidNetwork = NetworkGraph<u64, f32>` のように型エイリアスで定義可能
- **分離性**: 各ネットワークは独立した `NetworkGraph` インスタンスを持つことで、相互干渉を防止
- **テスト容易性**: 既存の `NetworkGraph` テストがそのまま利用可能

**実装方針**:
```rust
// src/core/network.rs に型エイリアスを追加
pub type PowerNetwork = NetworkGraph<u64, f32>;
pub type FluidNetwork = NetworkGraph<u64, f32>;
pub type SignalNetwork = NetworkGraph<u64, u8>;

// 各ネットワークの固有データ
pub struct PowerNetworks {
    pub networks: HashMap<GridId, PowerNetwork>,
}

pub struct FluidNetworks {
    pub networks: HashMap<GridId, FluidNetwork>,
}

pub struct SignalNetworks {
    pub networks: HashMap<GridId, SignalNetwork>,
}
```

---

### 2. ネットワーク計算アルゴリズム

**問題**: 3つのネットワークすべてで効率的なグラフ計算が必要。ネットワークは動的に変更される（ワイヤ/パイプ追加・削除、機械配置・破壊）。

**調査事項**:
- 電力システムの実験で使用した Union-Find が流体・信号にも適用可能か
- 流体の圧力計算と信号の伝播で同じアルゴリズムが使えるか
- 100ノード以上のネットワークで50ms以内に計算できるか

**決定**: Union-Find（Disjoint Set Union）を全3ネットワークに使用

**根拠**:
- **電力システムの実験**: 既に Union-Find が有効と確認済み（O(α(n)) amortized）
- **流体ネットワーク**: 圧力計算は単純な伝播モデルで、Union-Find で十分
- **信号ネットワーク**: 信号伝播はグラフ探索で、Union-Find でネットワーク検出が可能
- **パフォーマンス**: 100ノードであれば、Union-Find は50ms以内に十分完了
- **コード共有**: 同一アルゴリズムを使用することで、メンテナンスが容易

---

### 3. IoPort拡張とPortType追加

**問題**: 既存の機械システムは `IoPort` を使用して接続を管理している。電力・流体・信号の新しい接続タイプを追加する必要がある。

**決定**: `IoPort.port_type` に `Power`, `Fluid`, `Signal` を追加、複数ポートタイプをサポート

**根拠**:
- **既存アーキテクチャ**: `.claude/architecture.md` で `PortType::Item, Fluid, Power, Signal` の拡張が設計済み
- **コンベア実装**: `src/logistics/conveyor.rs` で `IoPort` が使用済み、パターンが存在
- **柔軟性**: 1つの機械が電力・流体・信号のポートを同時に持てる

---

### 4. 機械システムとの統合

**決定**: `generic_machine_tick()` の冒頭でネットワーク状態チェック、いずれかの条件が満たされない場合は早期リターン

**根拠**:
- **既存パターン**: `src/machines/generic/tick.rs` にレシピ処理ロジックが集約されている
- **責任の分離**: ネットワーク状態はシステム全体の前提条件であり、tick処理の冒頭でチェックするのが自然
- **論理積**: すべての条件（電力あり、流体あり、信号ON）が満たされた場合のみ機械が動作

---

### 5. 流体プロパティの実装

**決定**: `FluidSpec` に粘度・温度フィールド追加、パイプネットワークで流体タイプを保存

**根拠**:
- **データ駆動**: `FluidSpec` を定義することで、Mod で新しい流体を追加可能
- **単純化**: 温度はシステム全体で保存し、個別のブロックで保存しない（簡略化）
- **混合防止**: 1つのパイプネットワークは1つの流体タイプのみを持つ

---

### 6. 信号伝播の減衰モデル

**決定**: Minecraft レッドストーンスタイルの減衰モデルを採用（強度 0-15、減衰 1/ブロック）

**根拠**:
- **直感的**: プレイヤーに馴染みのあるモデル
- **設計済み**: `.claude/architecture.md` で `signal_strength: u8` が設計済み
- **計算の単純さ**: 距離による減衰は単純な減算で実装可能

---

### 7. イベントシステムとの統合

**決定**: 重要な状態変化のみイベント化、高頻度イベントは除外

**根拠**:
- **既存パターン**: `.claude/architecture.md` で `ConveyorTransfer`, `PlayerMoved` は高頻度除外
- **パフォーマンス**: 全ての変化を通知すると、システムが重くなる
- **有用性**: 重要な変化（電力喪失、信号変化）のみを通知で十分

---

### 8. UI フィードバックの実装

**決定**: 既存の機械 UI にネットワーク状態を追加、専用のネットワーク統計 UI を新規作成

**根拠**:
- **既存 UI**: `src/machines/generic/ui.rs` に機械 UI の実装済み
- **拡張性**: 既存 UI に状態表示を追加するだけで、新規 UI も必要
- **ユーザビリティ**: ネットワーク統計は専用 UI で一覧表示すると便利

---

### 9. セーブ/ロードの対応

**決定**: 既存の V2 セーブ形式を拡張、不明 ID は警告＋デフォルト値

**根拠**:
- **既存システム**: `src/save/format/` に V2 セーブ形式が実装済み
- **一貫性**: 同じ形式を使用することで、セーブ/ロードの一貫性を維持
- **安全性**: 不明 ID でパニックせず、デフォルト値でフォールバック

---

### 10. テスト戦略

**決定**: 単体テスト（Component・システム）＋統合テスト（ネットワーク連携）＋シナリオテスト（ユーザーストーリー）

**根拠**:
- **段階的検証**: 単体テストで基本機能を検証、統合テストで連携を検証、シナリオテストでユーザー体験を検証
- **既存パターン**: 電力システムの実験でシナリオテストが有効と確認済み
- **カバレッジ**: テストカバレッジを高めることで、バグを早期発見

---

## まとめ

### 技術スタック

| 項目 | 選択 | 理由 |
|------|------|------|
| グラフ計算 | Union-Find | 動的変更に効率的 |
| 共通基盤 | `NetworkGraph<K, V>` | 再利用可能 |
| ポート拡張 | `PortType::Item, Fluid, Power, Signal` | 既存 IoPort 活用 |
| 信号減衰 | 1/ブロック（レッドストーンスタイル） | 直感的 |
| イベント | 重要な変化のみ通知 | パフォーマンス |
| セーブ形式 | V2 形式拡張 | 既存システムとの整合性 |

### 主要な決定事項

1. **Union-Find** を全3ネットワークに使用
2. **IoPort拡張** で `PortType::Fluid, Power, Signal` を追加
3. **機械統合** は `generic_machine_tick()` の冒頭でチェック
4. **流体プロパティ** は `FluidSpec` で定義
5. **信号減衰** は 1/ブロック
6. **UI フィードバック** は既存 UI に状態表示追加＋統計 UI 新規
7. **セーブ/ロード** は V2 形式拡張
8. **テスト** は単体＋統合＋シナリオ

---

*最終更新: 2026-01-30*
