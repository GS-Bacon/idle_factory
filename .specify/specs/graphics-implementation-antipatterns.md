# ゲームグラフィック/レンダリング実装アンチパターン

**作成日**: 2025-12-22
**目的**: プレイヤーを不快にさせるグラフィック実装の失敗例と対策

---

## 1. 致命的アンチパターン

### 1.1 シェーダースタッター（Shader Stutter）

> 「Silent Hill 2 Remakeは最大の問題。シェーダーコンパイルプロセスがなく、プレイ中にスタッターが発生」
> — DSOG 2024年ワースト最適化ゲームリスト

**症状**:
- 新しいエフェクト/オブジェクト出現時にフリーズ
- 数フレーム〜数秒の停止
- 特に序盤やエリア移動時に頻発

**2024年の問題ゲーム**:
- Silent Hill 2 Remake
- STALKER 2
- Black Myth: Wukong
- Until Dawn Remake

**対策**:
```
✓ 起動時のシェーダープリコンパイル
✓ ローディング画面中にコンパイル
✓ PSOキャッシュの保存/読み込み
✓ シェーダーバリエーションの最小化
```

---

### 1.2 トラバーサルスタッター（Traversal Stutter）

**症状**:
- 移動中に定期的なスタッター
- 新しいエリアに入るたびにフリーズ
- ストリーミング読み込みの失敗

**2024年の問題ゲーム**:
- Frostpunk 2
- Alone in the Dark
- Outcast – A New Beginning

**原因**:
```
❌ HDDを考慮していないストリーミング設計
❌ チャンク境界でのメッシュ生成
❌ LOD切り替え時の負荷
```

**対策**:
```
✓ SSDを推奨環境に
✓ 非同期ローディング
✓ プリフェッチ（先読み）
✓ LOD切り替えのスムーズ化
```

---

### 1.3 フレームタイム変動（Frame Time Variance）

> 「平均60FPSでもフレームタイムが不安定だとカクつく」

**症状**:
- FPSカウンターは60なのにカクつく
- 一部のフレームだけ長い
- 不規則なスタッター

**原因**:
```
❌ ガベージコレクション
❌ 非同期処理の完了待ち
❌ 物理演算の突発的負荷
❌ UIの毎フレーム再描画
```

**対策**:
```
✓ フレームタイム監視（平均だけでなく99パーセンタイル）
✓ 重い処理の分散
✓ ダブル/トリプルバッファリング
✓ 固定タイムステップの検討
```

---

### 1.4 VRAMリーク（VRAM Leak）

**症状**:
- プレイ時間が長くなるとパフォーマンス低下
- 数時間後にクラッシュ
- テクスチャが読み込まれなくなる

**対策**:
```
✓ テクスチャ/メッシュの明示的解放
✓ アセット参照カウント管理
✓ 長時間テストの実施
✓ メモリプロファイリング
```

---

## 2. 最適化アンチパターン

### 2.1 個別描画地獄（Draw Call Hell）

**症状**:
- オブジェクト数に比例してFPS低下
- CPUがボトルネック
- GPUは遊んでいる

**原因**:
```rust
// 悪い例: 毎回新しいメッシュ/マテリアルを作成
for i in 0..1000 {
    commands.spawn((
        Mesh3d(meshes.add(Cuboid::default())),  // 毎回新規
        MeshMaterial3d(materials.add(Color::WHITE)),
    ));
}
// → 1000回の描画コール
```

**対策**:
```rust
// 良い例: ハンドルを共有
let shared_mesh = meshes.add(Cuboid::default());
let shared_material = materials.add(Color::WHITE);

for i in 0..1000 {
    commands.spawn((
        Mesh3d(shared_mesh.clone()),
        MeshMaterial3d(shared_material.clone()),
    ));
}
// → 1回のインスタンス描画
```

**目標**: <500描画コール/フレーム

---

### 2.2 カリング不足（Culling Neglect）

**症状**:
- 見えないオブジェクトも描画
- 大規模シーンでFPS低下
- GPUが常にフル稼働

**チェックリスト**:
```
□ フラスタムカリング有効か
□ オクルージョンカリング検討
□ LODシステム実装
□ 距離カリング設定
```

---

### 2.3 オーバードロー過多（Excessive Overdraw）

> 「パーティクルが画面を埋め尽くすとFPSが激減」

**症状**:
- エフェクト多用時にFPS低下
- 透明オブジェクトが多いシーンで重い
- 解像度を上げると急激に重くなる

**原因**:
```
❌ 大量の透明パーティクル
❌ 重なる半透明UI
❌ フルスクリーンポストエフェクト過多
```

**目標値**:
| デバイス | 許容オーバードロー |
|---------|-------------------|
| PC（高性能） | <3.0 |
| PC（中性能） | <2.0 |
| モバイル | <1.5 |

---

### 2.4 テクスチャアトラス未使用

**症状**:
- テクスチャ切り替えで描画バッチが分断
- マテリアル数が膨大
- VRAM使用量増加

**対策**:
```
✓ 同種オブジェクトのテクスチャをアトラス化
✓ UV座標でアトラス内位置を指定
✓ ミップマップレベルの注意（ブリーディング対策）
```

---

## 3. ボクセル/工場ゲーム特有のアンチパターン

### 3.1 毎フレームメッシュ再生成

**症状**:
- ブロック変更のたびにスタッター
- CPU使用率が常に高い
- 大規模建築が重い

**対策**:
```rust
// 悪い例
fn update(mut chunks: Query<&mut Chunk>) {
    for chunk in &mut chunks {
        regenerate_mesh(chunk);  // 毎フレーム全チャンク
    }
}

// 良い例
fn update(mut chunks: Query<&mut Chunk, Changed<Chunk>>) {
    for chunk in &mut chunks {
        chunk.mesh_dirty = true;
    }
}

fn regenerate_dirty_meshes(mut chunks: Query<&mut Chunk>) {
    for chunk in chunks.iter_mut().filter(|c| c.mesh_dirty) {
        regenerate_mesh(chunk);
        chunk.mesh_dirty = false;
    }
}
```

---

### 3.2 チャンク境界問題

**症状**:
- チャンク境界に隙間
- 境界でライティングが不連続
- 境界越えでスタッター

**対策**:
```
✓ 隣接チャンクの情報を参照してメッシュ生成
✓ 境界ボクセルのキャッシュ
✓ チャンク更新の連鎖制御
```

---

### 3.3 アイテムエンティティ爆発

> 「コンベア上の1000個のアイテムを個別エンティティにしたらFPS10に」

**症状**:
- アイテム数に比例してFPS低下
- コンベアが詰まると極端に重くなる

**対策**:
```rust
// 悪い例: アイテムごとにエンティティ
for item in conveyor.items {
    commands.spawn((
        Mesh3d(item_mesh.clone()),
        Transform::from_translation(item.position),
    ));
}

// 良い例: インスタンシング
commands.spawn((
    Mesh3d(item_mesh.clone()),
    InstancedPositions(conveyor.items.iter().map(|i| i.position).collect()),
));
```

---

### 3.4 機械アニメーション過多

**症状**:
- 動く機械が多いとFPS低下
- 画面外の機械もアニメーション

**対策**:
```
✓ 画面外の機械はアニメーション停止
✓ 距離によるアニメーション簡略化
✓ 複数機械のアニメーション同期
```

---

## 4. UI/グラフィック設定アンチパターン

### 4.1 設定項目不足

**症状**:
- 「グラフィック品質」しかない
- 個別に調整できない
- 問題の切り分けができない

**最低限必須**:
```
□ 解像度
□ フルスクリーンモード
□ VSync
□ FPS上限
□ 影品質
□ 描画距離
```

---

### 4.2 設定反映に再起動必要

**症状**:
- 設定変更後に「再起動が必要です」
- 試行錯誤が面倒
- プレイヤーが最適設定を見つけられない

**対策**:
```
✓ 可能な限りホットリロード対応
✓ 再起動必要な項目は明示
✓ プレビュー機能の提供
```

---

### 4.3 アクセシビリティ無視

**症状**:
- 色覚サポートなし
- UIスケール固定
- コントラスト不足

**影響**:
- 色覚異常者の8%（男性の12人に1人）
- 低視力者
- 高齢プレイヤー

**必須対応**:
```
✓ 色覚モード（3種類以上）
✓ 高コントラストモード
✓ UIスケール調整（100-200%）
✓ 字幕サイズ調整
```

---

## 5. 視認性アンチパターン

### 5.1 情報過多（Visual Noise）

> 「Satisfactoryは見た目が良いが、一度に見える情報量が少ない」

**症状**:
- 何が起きているか把握できない
- 重要な情報が埋もれる
- 目が疲れる

**Factorio vs Satisfactory**:
| 項目 | Factorio | Satisfactory |
|------|----------|--------------|
| 視点 | 2D俯瞰 | 3D一人称 |
| 一度に見える範囲 | 広い | 狭い |
| 情報密度 | 高（管理しやすい） | 低（見た目重視） |

**工場ゲームでの教訓**:
```
✓ 機能性 > 見た目（必要に応じて）
✓ ズームアウト時の情報表示
✓ ミニマップ/全体図の提供
```

---

### 5.2 コントラスト不足

**症状**:
- 文字が読めない
- ボタンが識別できない
- 背景に溶け込む

**WCAG基準**:
| 要素 | 最低コントラスト比 |
|------|-------------------|
| 通常テキスト | 4.5:1 |
| 大きいテキスト | 3:1 |
| UI要素 | 3:1 |

---

### 5.3 色だけに依存した情報伝達

**症状**:
- 赤と緑で状態表示
- 色覚異常者が区別できない

**対策**:
```
✓ 色 + 形状/アイコン
✓ 色 + テキストラベル
✓ 色 + パターン/模様
```

---

## 6. アンチパターン速見表

### 致命的（必ず回避）

| パターン | 症状 | 対策 |
|----------|------|------|
| シェーダースタッター | 描画時フリーズ | プリコンパイル |
| トラバーサルスタッター | 移動時フリーズ | 非同期ロード |
| フレームタイム変動 | カクつき | 処理分散 |
| VRAMリーク | 長時間で劣化 | 明示的解放 |

### 強く回避

| パターン | 症状 | 対策 |
|----------|------|------|
| 描画コール過多 | CPU負荷 | インスタンシング |
| カリング不足 | GPU負荷 | フラスタム/オクルージョン |
| オーバードロー | エフェクトで重い | パーティクル最適化 |
| メッシュ毎フレーム再生成 | 常時CPU高負荷 | ダーティフラグ |

### 注意

| パターン | 症状 | 対策 |
|----------|------|------|
| 設定項目不足 | 調整不可 | 個別設定追加 |
| アクセシビリティ無視 | 排除 | 色覚/スケール対応 |
| コントラスト不足 | 読めない | 4.5:1以上 |
| 情報過多 | 疲れる | シンプル化 |

---

## 7. チェックリスト

### パフォーマンス
- [ ] シェーダープリコンパイルがあるか
- [ ] 60FPSで安定しているか
- [ ] フレームタイム変動は5ms以内か
- [ ] 描画コールは500以下か
- [ ] 4時間プレイでメモリリークがないか

### 最適化
- [ ] インスタンシング/バッチングを活用しているか
- [ ] カリングが適切に機能しているか
- [ ] LODシステムがあるか
- [ ] パーティクルのオーバードロー対策があるか

### 設定UI
- [ ] 十分なグラフィック設定があるか
- [ ] ホットリロード対応か
- [ ] 色覚モードがあるか
- [ ] UIスケール調整があるか

### 視認性
- [ ] コントラスト比は4.5:1以上か
- [ ] 色だけに依存していないか
- [ ] 重要情報が見やすいか

---

## 参考文献

- [Here Are the Worst Optimized PC Games of 2024 | DSOG](https://www.dsogaming.com/articles/here-are-the-worst-optimized-pc-games-of-2024/)
- [What Is Shader Compilation | How-To Geek](https://www.howtogeek.com/846514/what-is-shader-compilation-and-why-does-it-make-pc-games-stutter/)
- [Factorio vs Satisfactory | This vs That](https://thisvsthat.io/factorio-vs-satisfactory)
- [Color Blindness Accessibility | Filament Games](https://www.filamentgames.com/blog/color-blindness-accessibility-in-video-games/)
- [Xbox Accessibility Guidelines | Microsoft](https://learn.microsoft.com/en-us/gaming/accessibility/xbox-accessibility-guidelines/112)

---

*このレポートはプレイヤーレビューと技術資料に基づいています。*
