# エディタ連携仕様

## 概要

Factory Data Architect - ゲームデータを視覚的に編集するTauriベースのデスクトップアプリ。
**非プログラマでもMODを作れる**ことを目指す。

## アーキテクチャ

```
┌─────────────────┐      ┌─────────────────┐
│  Factory Data   │      │     Game        │
│   Architect     │ ←──→ │  (Bevy/Rust)    │
│  (Tauri/React)  │ YAML │                 │
└─────────────────┘      └─────────────────┘
        │                         │
        └────── IPC/Pipe ─────────┘
              (テストプレイ時)
```

| 項目 | 技術 |
|------|------|
| エディタ | Tauri + React + TypeScript |
| データ形式 | YAML |
| 連携方式 | ファイル経由 + IPC（テストプレイ） |

---

## ゲームとの連携

### 連携方式一覧

| 方式 | 説明 | 用途 |
|------|------|------|
| ホットリロード | ファイル変更を自動検知 | 開発中のイテレーション |
| テストプレイ | エディタからゲーム起動 | 動作確認 |
| デバッグモード | ゲーム内コマンド | テスト効率化 |
| エクスポート | MODパッケージ出力 | 配布 |

### ホットリロード詳細

#### 技術仕様

| 項目 | 仕様 |
|------|------|
| ファイル監視 | notify-rsライブラリ（クロスプラットフォーム） |
| 検知方式 | イベント駆動（polling fallback） |
| 検知→反映 | 100ms以内 |
| 対象ディレクトリ | `data/`, `lang/` |

#### リロード対象

| 対象 | ホットリロード | 備考 |
|------|----------------|------|
| アイテム定義 | ✓ | 即時反映 |
| レシピ定義 | ✓ | 進行中レシピは完了後に新定義適用 |
| クエスト定義 | ✓ | 進行状況は維持 |
| テキスト（i18n） | ✓ | 即時反映 |
| 機械定義 | △ | 既存機械は再設置必要 |
| 3Dモデル | ✗ | 再起動必要 |
| Luaスクリプト | ✓ | 次回実行時に反映 |

#### エラー処理

| エラー | 動作 | 通知 |
|--------|------|------|
| YAML構文エラー | リロードスキップ、前の状態維持 | エディタに赤枠表示 |
| 参照エラー（存在しないID） | リロード実行、該当参照は無効化 | ゲーム内警告ログ |
| 型エラー（数値に文字列） | リロードスキップ | エディタにエラー詳細 |

#### コンフリクト防止

| 状況 | 対策 |
|------|------|
| エディタ保存中にゲーム読み込み | ファイルロック（100msリトライ） |
| 同時編集 | エディタ側に「ゲームで変更あり」通知 |

### テストプレイ詳細

#### 起動オプション

| オプション | 説明 |
|------------|------|
| 新規ワールド | テスト用の一時ワールドを生成 |
| 既存ワールド | 指定ワールドをコピーして起動 |
| クイックスタート | Tier指定で開始（Tier 3スタート等） |
| 特定クエストから | 指定クエストをアクティブ状態で開始 |

#### テスト用セーブデータ

| 項目 | 仕様 |
|------|------|
| 保存先 | `saves/_test/` （本番と分離） |
| 自動削除 | テスト終了時に確認ダイアログ |
| 本番化 | 「このワールドを保存」で本番に移動 |

### デバッグ機能

テストプレイ時に使用可能なデバッグコマンド。

#### デバッグコンソール（F12）

| コマンド | 効果 |
|----------|------|
| `/give <item_id> [count]` | アイテムを付与 |
| `/complete <quest_id>` | クエストを完了状態に |
| `/unlock <tier>` | 指定ティアまで解放 |
| `/tp <x> <y> <z>` | テレポート |
| `/time <hour>` | 時刻を変更（0-24） |
| `/weather <type>` | 天候を変更（clear/rain/storm） |
| `/power infinite` | 電力無限モード |
| `/power normal` | 通常モードに戻す |
| `/reload` | 全データをホットリロード |

#### デバッグUI（F11）

| 表示 | 内容 |
|------|------|
| FPS/メモリ | パフォーマンス情報 |
| チャンク情報 | ロード状態、エンティティ数 |
| 電力グラフ | 発電/消費のリアルタイム表示 |
| 物流フロー | コンベア上のアイテム流量 |

---

## 検証機能

### 自動検証

エディタで保存時に自動実行。

| 検証項目 | 検出内容 | 重要度 |
|----------|----------|--------|
| ID重複 | 同じIDが複数存在 | エラー |
| 参照整合性 | 存在しないIDを参照 | エラー |
| 循環依存 | レシピ A→B→A | エラー |
| 未使用アイテム | どのレシピでも使わない | 警告 |
| 到達不能 | 生産手段がないアイテム | 警告 |
| クエスト孤立 | 前提がないメインクエスト | 警告 |

### 手動検証

「検証」メニューから実行。

| 検証 | 内容 |
|------|------|
| 全アイテム生産可能性 | 初期状態から全アイテムが生産可能か |
| クエスト到達可能性 | 全クエストがクリア可能か |
| 電力バランス | ティアごとの発電/消費が適切か |
| レシピチェーン表示 | 原料→最終製品の依存グラフ |

### レシピチェーン可視化

```
[鉄鉱石] ─→ [精錬炉] ─→ [鉄インゴット] ─→ [プレス機] ─→ [鉄板]
                                    ↓
                              [組立機] ─→ [回路基板]
                                    ↑
[銅鉱石] ─→ [精錬炉] ─→ [銅インゴット] ─→ [ワイヤー加工機] ─→ [銅ワイヤー]
```

---

## 編集タブ

### Items（アイテム）

アイテムの定義を編集。

| 機能 | 説明 |
|------|------|
| リスト表示 | 全アイテム一覧、検索/フィルタ |
| プロパティ編集 | ID、名前、スタック数、カテゴリ |
| アイコンプレビュー | 3Dモデルからアイコン生成 |
| 重複チェック | ID重複を警告 |
| **複製** | 既存アイテムをベースに新規作成 |
| **テンプレート** | プリセットから作成 |

#### テンプレート

| テンプレート | 内容 |
|--------------|------|
| 素材 | スタック999、カテゴリ:material |
| 加工品 | スタック999、カテゴリ:intermediate |
| 機械 | スタック50、カテゴリ:machine |
| ツール | スタック1、カテゴリ:tool |

```yaml
# item_definition.yaml
id: iron_ingot
name_key: item.iron_ingot  # i18n用
category: material
stack_size: 999
model: items/iron_ingot.gltf
```

### Recipes（レシピ）

レシピをノードベースで編集。

| 機能 | 説明 |
|------|------|
| ノードエディタ | React Flow使用 |
| 入出力接続 | ドラッグ&ドロップ |
| 機械指定 | どの機械で処理するか |
| 時間/電力設定 | 処理時間、消費電力 |
| **スループット計算** | 必要機械数を自動計算 |
| **バランスチェック** | 入出力比率を警告 |

#### スループット計算機

指定した生産目標に対して：
- 必要な機械数
- 必要な入力コンベアレーン数
- 消費電力の合計

```yaml
# recipe_definition.yaml
id: iron_plate
machine: press
inputs:
  - item: iron_ingot
    count: 2
outputs:
  - item: iron_plate
    count: 1
time: 2.0  # 秒
power: 15  # kW
```

### Machines（機械）

機械の定義を編集。

| 機能 | 説明 |
|------|------|
| 基本プロパティ | サイズ、消費電力、処理速度 |
| 入出力設定 | スロット数、面ごとの設定 |
| ティア設定 | アップグレード関係 |
| モジュールスロット | 拡張スロット数 |
| **入出力面エディタ** | 6面それぞれの設定をビジュアル編集 |

```yaml
# machine_definition.yaml
id: smelter_t1
name_key: machine.smelter
size: [1, 1, 1]
tier: 1
power: 10  # kW
speed: 1.0
slots:
  input: 1
  fuel: 1
  output: 1
  module: 2
io_faces:
  top: input
  bottom: output
  sides: fuel
upgrades_to: smelter_t2
```

### Quests（クエスト）

クエストをツリー/リストで編集。

| 機能 | 説明 |
|------|------|
| ツリー表示 | 前提関係を可視化 |
| 目標設定 | 納品アイテム、数量 |
| 報酬設定 | 機械、アイテム、アンロック |
| 依存関係 | 前提クエスト設定 |
| **ジャンプテスト** | このクエストからテストプレイ |

```yaml
# quest_definition.yaml
id: automation_dawn
name_key: quest.automation_dawn
type: main
prerequisites:
  - first_step
objectives:
  - type: deliver
    item: iron_ingot
    count: 100
rewards:
  - type: item
    item: miner
    count: 2
  - type: unlock
    tier: 2
```

### Multiblock（マルチブロック）

マルチブロック構造を3Dで編集。

| 機能 | 説明 |
|------|------|
| 3Dグリッド | React Three Fiberで表示 |
| レイヤー表示 | 高さごとにスライス |
| ブロック配置 | クリックで配置/削除 |
| プレビュー | 完成形を3D表示 |
| **ゲーム内コピー** | ゲームで作った構造をインポート |

### Biomes（バイオーム）

バイオームと資源分布を編集。

| 機能 | 説明 |
|------|------|
| ノイズパラメータ | 周波数、振幅、オクターブ |
| 2Dプレビュー | Canvas 2Dでノイズ可視化 |
| 資源オーバーレイ | 資源バイオームの設定 |
| 出現バイオーム | どの自然バイオームに出るか |

### Scripts（Luaスクリプト）

Luaスクリプトの編集支援。

| 機能 | 説明 |
|------|------|
| シンタックスハイライト | Monaco Editor使用 |
| API補完 | ゲームAPIの入力補完 |
| リファレンス | サイドパネルにAPI一覧 |
| テスト実行 | スクリプト単体でテスト |
| エラー表示 | 構文エラーをリアルタイム表示 |

### Sounds（サウンド）

サウンド設定を編集。

| 機能 | 説明 |
|------|------|
| カテゴリツリー | マスター > BGM/SE/Voice |
| プレビュー再生 | その場で音を確認 |
| バリエーション | 同一サウンドの複数ファイル |
| 空間設定 | 距離減衰、3D設定 |

### Localization（ローカライズ）

多言語対応を編集。

| 機能 | 説明 |
|------|------|
| キー一覧 | 全翻訳キーをリスト |
| 言語切替 | 編集する言語を選択 |
| 未翻訳表示 | 翻訳が足りない項目をハイライト |
| プレビュー | ゲーム内での表示をプレビュー |
| **自動翻訳** | DeepL/Google翻訳API連携（オプション） |

---

## UX原則

| 原則 | 実装 |
|------|------|
| 即時プレビュー | 編集結果をリアルタイム反映 |
| 非破壊編集 | Undo 100回以上 |
| 制約可視化 | 無効な設定を赤表示 |
| スマートデフォルト | よく使う値を初期設定 |
| 一括操作 | 複数選択して編集 |
| 参照整合性 | 削除時に参照元を警告 |
| **複製機能** | 既存データをベースに新規作成 |
| **テンプレート** | プリセットから素早く作成 |

---

## MOD開発ワークフロー

### 1. プロジェクト作成

```
File > New MOD Project
  ├─ MOD名入力
  ├─ 作者名入力
  ├─ テンプレート選択
  │    ├─ 空のMOD
  │    ├─ 新機械追加
  │    ├─ 新レシピ追加
  │    └─ オーバーホール
  └─ 作成
```

### 2. 編集

各タブで定義を追加・編集。

### 3. 検証

`Tools > Validate All` で全体検証。

### 4. テスト

「テストプレイ」でゲーム起動、動作確認。

### 5. エクスポート

```
File > Export MOD
  ├─ バージョン入力
  ├─ 変更履歴入力
  └─ パッケージ生成（.zip）
```

### MODパッケージ構造

```
my-mod/
├── manifest.yaml    # MODメタ情報
├── data/
│   ├── items.yaml
│   ├── recipes.yaml
│   ├── quests.yaml
│   └── machines.yaml
├── assets/
│   ├── models/
│   └── sounds/
├── scripts/         # Luaスクリプト
└── lang/
    ├── en.yaml
    └── ja.yaml
```

### manifest.yaml

```yaml
id: my-awesome-mod
name: My Awesome Mod
version: 1.0.0
author: username
description: Adds cool machines
license: MIT  # または CC-BY-4.0 等
game_version: ">=1.0.0"
dependencies:
  - base: ">=1.0.0"
  - optional:some-mod: ">=2.0.0"  # オプション依存
conflicts:
  - incompatible-mod  # 非互換MOD
```

---

## ゲーム内ブループリントとの連携

### エディタ → ゲーム

| 機能 | 説明 |
|------|------|
| マルチブロック定義 | エディタで作成 → ゲームで設置可能 |
| プリセット配置 | エディタで機械配置をデザイン → ブループリント化 |

### ゲーム → エディタ

| 機能 | 説明 |
|------|------|
| 構造インポート | ゲーム内で選択 → エディタにマルチブロックとして取り込み |
| ブループリント編集 | ゲームで作ったBPをエディタで調整 |

### 連携手順

```
1. ゲーム内で構造を選択（ブループリントツール）
2. 「エディタに送信」を選択
3. エディタのMultiblockタブに反映
4. 編集・調整
5. 保存 → ゲームにホットリロード
```

---

## 設計思想

| ポイント | 理由 |
|----------|------|
| Tauriで外部アプリ | ゲームと分離、開発効率UP |
| YAMLデータ形式 | 可読性高い、マージしやすい |
| ホットリロード | 編集サイクル高速化 |
| MODエクスポート | コミュニティ貢献しやすい |
| デバッグ機能 | テスト効率化 |
| 検証機能 | バグの早期発見 |
| テンプレート | 学習曲線を緩やかに |
