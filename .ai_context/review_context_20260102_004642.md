# コードレビュー依頼

## レビュータイプ: general

## 評価基準
1. アーキテクチャ (10点): モジュール分割、依存関係
2. コード品質 (10点): 可読性、命名規則
3. Bevyパターン (10点): ECS活用、Plugin構成
4. 安全性 (10点): エラーハンドリング、unwrap使用
5. 拡張性 (10点): 将来の機能追加

## 出力形式
- 各項目のスコア
- 良い点3つ
- 改善点3つ
- 総合評価

---

## レビュー対象コード

### src/main.rs
```rust
//! Idle Factory - Milestone 1: Minimal Voxel Game
//! Goal: Walk, mine blocks, collect in inventory

// Use library crate for all game logic
use idle_factory::components::*;
use idle_factory::events::GameEventsPlugin;
#[cfg(target_arch = "wasm32")]
use idle_factory::logging::GameLoggingPlugin;
use idle_factory::logging;
use idle_factory::player::Inventory;
use idle_factory::plugins::{DebugPlugin, MachineSystemsPlugin, SavePlugin, UIPlugin};
use idle_factory::setup::{setup_initial_items, setup_lighting, setup_player, setup_ui};
use idle_factory::systems::{
    // Block operation systems
    block_break, block_place,
    // Player systems
    player_look, player_move, tick_action_timers, toggle_cursor_lock, tutorial_dismiss,
    // Chunk systems
    receive_chunk_meshes, spawn_chunk_tasks, unload_distant_chunks,
    // UI systems
    select_block_type,
    // Command events and handlers
    TeleportEvent, LookEvent, SetBlockEvent, handle_teleport_event,
    handle_look_event, handle_setblock_event, handle_spawn_machine_event, handle_debug_conveyor_event,
    handle_assert_machine_event, DebugConveyorEvent, AssertMachineEvent,
    // Quest systems
    load_machine_models, quest_claim_rewards, quest_deliver_button, quest_progress_check,
    setup_delivery_platform, update_delivery_ui, update_quest_ui,
    // Targeting systems
    rotate_conveyor_placement, update_conveyor_shapes, update_guide_markers,
    update_target_block, update_target_highlight,
};
use idle_factory::world::{BiomeMap, ChunkMeshTasks, WorldData};
use bevy::prelude::*;
#[cfg(not(target_arch = "wasm32"))]
use bevy::render::pipelined_rendering::PipelinedRenderingPlugin;
#[cfg(not(target_arch = "wasm32"))]
use bevy::window::PresentMode;

fn main() {
    // WASM: Set panic hook to display errors in browser console
    #[cfg(target_arch = "wasm32")]
    console_error_panic_hook::set_once();

    // Initialize logging before anything else
    #[cfg(not(target_arch = "wasm32"))]
    let _log_guard = logging::init_logging();

    let mut app = App::new();

    // Configure plugins based on platform
    #[cfg(not(target_arch = "wasm32"))]
    {
        // Native: Disable pipelined rendering for lower input lag
        // Disable LogPlugin to use custom tracing-subscriber instead
        use bevy::log::LogPlugin;
        // Use current working directory for assets (not executable path)
        app.add_plugins((
            DefaultPlugins
                .build()
                .disable::<PipelinedRenderingPlugin>()
                .disable::<LogPlugin>()
                .set(AssetPlugin {
                    file_path: "assets".to_string(),
                    ..default()
                })
                .set(WindowPlugin {
                    primary_window: Some(Window {
                        title: "Idle Factory".into(),
                        present_mode: PresentMode::AutoNoVsync,
                        desired_maximum_frame_latency: std::num::NonZeroU32::new(1),
                        ..default()
                    }),
                    ..default()
                }),
        ));
    }

    #[cfg(target_arch = "wasm32")]
    {
        // WASM: Use default plugins with canvas selector
        // Disable LogPlugin to use tracing_wasm instead
        use bevy::log::LogPlugin;
        app.add_plugins(
            DefaultPlugins
                .build()
                .disable::<LogPlugin>()
                .set(WindowPlugin {
                    primary_window: Some(Window {
                        title: "Idle Factory".into(),
                        canvas: Some("#bevy-canvas".to_string()),
                        fit_canvas_to_parent: true,
                        prevent_default_event_handling: true,
                        ..default()
                    }),
                    ..default()
                }),
        );
    }

    // WASM: Add logging plugin (Native logging is initialized above)
    #[cfg(target_arch = "wasm32")]
    app.add_plugins(GameLoggingPlugin);

    // Add VOX loader plugin for hot reload (native only)
    #[cfg(not(target_arch = "wasm32"))]
    app.add_plugins(idle_factory::vox_loader::VoxLoaderPlugin);

    app
        .add_plugins(GameEventsPlugin)
        .add_plugins(MachineSystemsPlugin)
        .add_plugins(UIPlugin)
        .add_plugins(SavePlugin)
        .add_plugins(DebugPlugin)
        .insert_resource(Inventory::with_initial_items(idle_factory::game_spec::INITIAL_EQUIPMENT))
        .init_resource::<WorldData>()
        .insert_resource(BiomeMap::new(12345)) // Fixed seed for deterministic biomes
        .init_resource::<CursorLockState>()
        .init_resource::<CurrentQuest>()
        .init_resource::<GameFont>()
        .init_resource::<ChunkMeshTasks>()
        .init_resource::<CreativeMode>()
        .init_resource::<ContinuousActionTimer>()
        .add_event::<TeleportEvent>()
        .add_event::<LookEvent>()
        .add_event::<SetBlockEvent>()
        .add_event::<DebugConveyorEvent>()
        .add_event::<AssertMachineEvent>()
        .add_systems(Startup, (setup_lighting, setup_player, setup_ui, setup_initial_items, setup_delivery_platform, load_machine_models))
        .add_systems(
            Update,
            (
                // Chunk systems: spawn → receive (ordered)
                spawn_chunk_tasks,
                receive_chunk_meshes,
                unload_distant_chunks,
            ).chain(),
        )
        .add_systems(
            Update,
            (
                // Player systems: look → move (camera affects movement direction)
                toggle_cursor_lock,
                player_look,
                player_move,
                tick_action_timers,
            ),
        )
        .add_systems(Update, tutorial_dismiss)
        // Targeting must run before block operations
        .add_systems(Update, update_target_block)
        .add_systems(Update, (block_break, block_place).after(update_target_block))
        .add_systems(Update, select_block_type)
        .add_systems(
            Update,
            (
                // Quest systems
                idle_factory::systems::targeting::update_conveyor_shapes,
                quest_progress_check,
                quest_claim_rewards,
            ),
        )
        .add_systems(
            Update,
            (
                // Quest UI systems
                update_delivery_ui,
                update_quest_ui,
                quest_deliver_button,
            ),
        )
        .add_systems(
            Update,
            (
                // Targeting highlight (after target_block update)
                update_target_highlight,
                rotate_conveyor_placement,
                update_conveyor_shapes,
                update_guide_markers,
            ).after(update_target_block),
        )
        .add_systems(
            Update,
            (
                // E2E command handlers
                handle_teleport_event,
                handle_look_event,
                handle_setblock_event,
                handle_spawn_machine_event,
                handle_debug_conveyor_event,
                handle_assert_machine_event,
            ),
        )
        .run();
}

// === Tests ===

#[cfg(test)]
mod tests {
```

