# Claude Code メモリ

## 用語定義（混同注意）

| 用語 | 意味 | コード上の対応 |
|------|------|---------------|
| **収納** | コンベア経由でプラットフォーム（倉庫）にアイテムが入ること | `TransferTarget::Delivery` |
| **納品** | クエストのためにアイテムを消費すること | `quest_deliver_button` |

※ユーザーが混同していそうな場合は確認すること

## UIプレビュー

UIデザインの確認・やり取りには `UIプレビュー/` フォルダを使用。

### 使い方

```bash
# ゲーム起動してスクショ保存
DISPLAY=:10 timeout 20 cargo run &
sleep 15
DISPLAY=:10 scrot "UIプレビュー/画面名.png"
```

### ルール

| ルール | 詳細 |
|--------|------|
| 用途 | UIデザインの確認・フィードバック用 |
| 保存先 | `UIプレビュー/` （gitignore済み） |
| ファイル名 | 日本語OK（例: `インベントリ画面.png`） |
| **削除タイミング** | **使ったら即削除** |

### フロー

1. スクショを撮って `UIプレビュー/` に保存
2. ユーザーに見せる
3. **見せたら即削除**

## 互換性ポリシー

- **既存プレイヤーはいない** → セーブデータ移行は不要
- **しばらくは後方互換性を気にしなくてよい**
- 破壊的変更OK、古いセーブ切り捨てOK

## メタワーク判定基準（重要）

### メタワーク（やらない）

| 例 | 理由 |
|----|------|
| 仕様書を詳細化する | ゲームが1行も進まない |
| ドキュメント整理・圧縮 | 誰も読まない |
| ドキュメントコメント追加 | 誰も読まない |
| レビュースキル・パターン集作成 | 使わない道具 |
| コード移動だけのリファクタ | バグ確率変わらない |

### メタワークではない（やる）

| 例 | 理由 |
|----|------|
| 自動テスト追加 | バグを早期発見、開発速度UP |
| E2E強化 | 遊べないバグを防ぐ |
| CI/起動確認スクリプト | クラッシュを即検出 |
| バグ修正 | 遊べるようにする |
| リファクタ（複雑さ解消） | 将来のバグ確率を減らす |
| アーキテクチャ改善 | 機能追加時のバグ確率を減らす |
| 重複コード統合 | 片方だけ直して忘れるバグを防ぐ |
| 機能追加 | ゲームが進む |
| UI/UX改善 | 体験が良くなる |
| パフォーマンス改善 | 遊べる体験に直結 |

### 判定フロー

```
これをやると...
  → ゲームが遊べるようになる？ → やる
  → 今のバグが減る？ → やる
  → 将来のバグ確率が減る？ → やる
  → 機能追加が速くなる？ → やる
  → ドキュメントが増えるだけ？ → やらない
```

**過去の失敗**: 仕様39ファイル・パターン52個・レビュースキル群を作り、誰もゲームを遊んでいなかった

## 基本ルール

| ルール | 詳細 |
|--------|------|
| ビルド | `cargo build` (2秒)、テスト後 `cargo test && cargo clippy` |
| コミット | 日本語、短く。**コミットは自己判断でOK**、pushは指示待ち |
| 中断禁止 | 確認を求めず最後まで完了 |
| ゲーム起動 | `./run.sh` |
| バグ修正 | **再現テストなしの修正禁止**。下記参照 |
| **タスク実行** | **必ず `./scripts/parallel-run.sh` を使う**。下記参照 |

## タスク実行ルール（必須）

**全てのタスクは git worktree + Task tool で並列実行する**（詳細: `./scripts/parallel-run.sh --help`）

```bash
./scripts/parallel-run.sh check 2   # 容量チェック（必須）
./scripts/parallel-run.sh start task-a && ./scripts/parallel-run.sh start task-b
# Task tool で並列作業
./scripts/parallel-run.sh finish task-a && ./scripts/parallel-run.sh finish task-b
```

**禁止**: 直列実行、masterで直接作業、worktree放置

**コンフリクト時**: `git checkout --theirs Cargo.lock Cargo.toml && git add . && git commit`

## バグ修正ルール

1. **再現テストを先に書く**（またはE2Eで再現確認）
2. テストが失敗することを確認
3. 修正する
4. テストがパスすることを確認
5. 関連テストも全部パスすることを確認

**禁止**: 「多分これが原因」で修正開始。必ずログかテストで原因特定してから。

## 禁止事項

- 仕様だけのセッション2回連続
- 憶測での修正（ログ/スクリーンショットで確認してから）
- ドキュメント整理・圧縮作業

## 新機能実装

**確認が必要**: 新ゲーム要素、UI/UX変更、ゲームバランス変更
**確認不要**: バグ修正、リファクタリング、テスト追加

仕様は `src/game_spec.rs` に定義（Single Source of Truth）

## 検証の分担

| 担当 | 内容 |
|------|------|
| AI | ビルド、テスト、E2E、スクリーンショット確認、UI動作 |
| 人間 | ゲームプレイ体験（面白さ、直感性） |

## 開発フロー

```
ユーザー: 修正 → プッシュ → AI: プル → 作業 → プッシュ → ユーザー: 確認
```

## ツール

| ツール | 用途 | ヘルプ |
|--------|------|--------|
| `gemini <cmd>` | Gemini連携（アーキ設計、レビュー、数学検証） | `gemini --help` |
| `./scripts/vlm_check.sh` | VLMビジュアルチェック | `scripts/vlm_check/README.md` |
| `./scripts/parallel-run.sh` | 並列タスク実行 | `--help` |

※Gemini使用条件: Gemini 3/2.5モデルの時のみ（トークン制限でモデル切り替わったら使わない）

## 参照ドキュメント

| ファイル | 内容 | 優先度 |
|----------|------|--------|
| **`.claude/architecture-future.md`** | **将来アーキテクチャ設計（権威ソース）** | **最優先** |
| `.claude/implementation-plan.md` | 統合実装計画（タスク一覧） | 高 |
| `.claude/architecture.md` | 現在のモジュール構成 | 中 |
| `.claude/bugs.md` | よくあるバグと対策 | 中 |
| `.specify/memory/constitution.md` | プロジェクト憲章 | 中 |
| `.specify/roadmap.md` | ロードマップ | 中 |

## 将来アーキテクチャ設計ルール（必須）

**`.claude/architecture-future.md` が全ての設計判断の権威ソース**

### 新規実装時

1. **必ず** `.claude/architecture-future.md` を参照
2. 将来設計と矛盾する実装は禁止
3. 将来設計にないパターンを使う場合は先に設計追記

### 禁止パターン（レガシー）

| 禁止 | 代替 |
|------|------|
| `PlayerInventory` (Resource) | `Inventory` (Component) + `LocalPlayer(Entity)` |
| 個別機械ファイル (`furnace.rs`等) | `machines/generic.rs` |
| `InteractingFurnace/Crusher/Miner` | `InteractingMachine(Option<Entity>)` |
| ハードコード機械ロジック | `MachineSpec` + データ駆動 |
| `BlockType` 直接参照 | `Id<Item>` (将来) |

### 整理対象

古い実装・タスク・ドキュメントを見つけたら：
1. 将来設計と照合
2. 矛盾があれば将来設計に従って修正
3. 不要なら削除

## 修正済みバグ

BUG-1〜9: 全て修正済み。詳細は `.claude/bugs.md` 参照。

## バイブコーディング限界実験

このプロジェクトは「非エンジニアがAIだけで大規模ゲームを作れるか」の実験。

### 記録ルール

**マイルストーンごとに作業ログへ以下を追記：**

| 項目 | 内容 |
|------|------|
| コード行数 | `wc -l src/**/*.rs` |
| テスト数 | `cargo test 2>&1 | grep "test result"` |
| 破綻の兆候 | 同じバグ再発、AIが矛盾した修正、無限ループなど |
| 人間介入 | 何を判断したか、なぜAIだけでは無理だったか |
| 回復方法 | どうやって立て直したか |

### 観測すべき破綻パターン

1. **コンテキスト限界** - AIが以前の決定を忘れる
2. **メタワーク暴走** - ゲームが進まずドキュメントだけ増える
3. **修正ループ** - AIがAIの書いたコードを直す無限ループ
4. **設計の不整合** - モジュール間で噛み合わない

### 暴走検知ルール

```
AIが1時間作業したら → ゲームを起動して変化を見せる
変化がない or 説明が長い → 暴走の兆候
```

### 定期リファクタリング

**マイルストーンごとに実行：**

```
「現在のプロジェクト構造を要約し、不要な複雑性を指摘せよ」
```

チェックポイント：
- 1000行超えファイルがないか
- 重複コードがないか
- 使われていないコードがないか
- テストカバレッジが落ちていないか

## 現在の状態

| 項目 | 値 |
|------|-----|
| バージョン | **0.3.78** |
| コード行数 | **~25,000行** |
| テスト | **232件** 通過 (lib) |
| Clippy警告 | **0件** |

## タスク

**詳細は `.claude/implementation-plan.md` 参照**

### Phase D.0-D.14 完了！（基盤強化 + QoL）

**全15モジュール実装済み**

| タスク | 効果 | 状態 |
|--------|------|------|
| C.1 BlockDescriptor | 新ブロック追加 100行→10行 | ✅ 完了 |
| C.2 ItemDescriptor | 新アイテム追加 50行→8行 | ✅ 完了 |
| C.3 MachineDescriptor + UIジェネレータ | 新機械追加 500行→20行 | ✅ 完了 |
| C.4 レジストリシステム | O(1)参照、一元管理 | ✅ 完了 |

### 完了済み（最新）

- ✅ **Phase C 完了** (2026-01-07)
  - C.1/C.2: ItemDescriptor統合（hardness, drops, stack_size）
  - C.3: MachineSpec + generic UI
  - C.4: GameRegistry with O(1) lookup
  - レガシー定数削除
- ✅ **Phase C.3 機械システム統合** (2026-01-07)
  - `generic_machine_tick` で全機械を統一処理
  - `setup_generic_machine_ui` でデータ駆動UI生成
  - Legacy機械コード削除 (-629行)
  - `InteractingMachine` 1リソースに統合
- ✅ **UIステート管理システム** (2026-01-06)
  - `UIState`, `UIAction`, `UIContext` 導入
  - ESC/E/Tab処理を集約
- ✅ **パフォーマンス最適化** (2026-01-06)
  - ChunkData HashMap削除 → メモリ50%減
  - Greedy meshing実装 → 頂点数50%減
  - GameSettings基盤実装

### 過去の完了

- ✅ Phase A: v0.2完成（チュートリアル、バイオームUI、UIテーマ）
- ✅ Phase B: アーキテクチャ再設計（物流分離、機械統合、UI統合）

### 将来機能 (v0.3以降)

**詳細は `.claude/architecture-future.md` 参照**

17機能を計画済み:
- 基盤: 電力、液体・気体、信号制御、クラフト
- 物流: 線路、ストレージ
- UI/UX: マップ、ブループリント、統計、サウンド、実績
- カスタマイズ: プレイヤースキン、Blockbenchインポート
- 拡張: Modding(フルアクセス)、マルチプレイ

### 次のPhase: D.0（マルチ準備）

**詳細は `.claude/architecture-future.md` 参照**

| タスク | 内容 |
|--------|------|
| D.0.1 | `LocalPlayer(Entity)` リソース追加 |
| D.0.2 | `Inventory` コンポーネント化 |
| D.0.3 | 既存システムを段階的に移行 |
| D.0.4 | `PlayerInventory` リソース削除 |
| D.0.5 | `MachineBundle` 導入 |

**決定済み設計**:
- イベントシステム: `GuardedEventWriter` で循環防止
- 動的ID: `Id<Category>` Phantom Type + `StringInterner`
- Mod API: `"namespace:id"` 形式、セマンティックバージョニング
- NetworkId: `EntityMap` で Entity ↔ NetworkId マッピング
