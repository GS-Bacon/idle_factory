# Claude Code メモリ

## 批判的姿勢（重要）

ユーザーの提案に対しても以下を確認し、問題があれば指摘する:
- 仕様地獄に戻っていないか？（詳細化・レビュー・パターン確認の連鎖）
- メタワークになっていないか？（ゲームを作らず道具を作っている）
- 実装より仕様が先行していないか？
- 「完璧」を目指して「完成」を遅らせていないか？

**過去の失敗**: 仕様39ファイル・パターン52個・レビュースキル群を作り、誰もゲームを遊んでいなかった

## 基本ルール

| ルール | 詳細 |
|--------|------|
| テスト | 実装後は `cargo test` と `cargo clippy` |
| コミット | 日本語メッセージ、適宜コミット、pushは指示待ち |
| 中断禁止 | 確認を求めず最後まで完了 |
| 動作確認 | E2Eテストで基本動作を検証 |
| ゲーム起動 | `./run.sh` を使用（RDPディスプレイ自動検出） |
| Gemini CLI | `gemini -m gemini-3-pro-preview -p "プロンプト"` を使用 |
| Gemini活用 | 3Dモデリング・座標計算・幾何学処理で精度検証中。効果確認後に本格採用 |

## 検証の分担

| 担当 | 内容 |
|------|------|
| AI | ビルド、テスト、E2E、クリック反応、UI動作 |
| 人間 | ゲームプレイ体験（面白さ、直感性） |

**AIが確認すべき**: 「クリックしても反応しない」等の技術的バグ
**人間が確認すべき**: 「遊んでいて楽しいか」等の体験

## 禁止事項

- 仕様だけのセッション2回連続
- パターン集の事前確認（問題が起きたら見る）
- レビュー・評価スキルの使用
- ドキュメント整理・圧縮作業

## 却下済みの提案（再提案時は指摘する）

| 提案 | 却下理由 |
|------|----------|
| 定期レビュー導入 | メタワーク復活の入口。問題が起きたらで十分 |
| TDD導入 | 「テストが通る」が目的化する。実装後テストで十分 |
| プロセス追加 | Milestone 1-2は規模が小さい。E2Eで十分 |

**導入検討タイミング**: Milestone 3以降、または問題が頻発したとき

## マイルストーン駆動

```
仕様（1ページ）→ 実装 → 動かして確認 → 次へ
```

「done」= テストが通る、ではなく「遊べる」

## 3Dモデル生成

「〇〇のモデルを作成」指示で:
1. `.specify/memory/modeling-rules.md` 参照
2. サブエージェント起動
3. 完了報告

## 実プレイ検証

実プレイ検証は後回しにし、ユーザーが確認することリストにまとめる。

## バグ修正の手順

**重要**: バグ修正タスクを受けたら、まずログを解析してから修正に着手する。

### 1. ログ取得
ユーザーにブラウザコンソールで以下を実行してもらう:
```javascript
exportGameLogs()  // JSONファイルがダウンロードされる
```

### 2. ログ解析
ダウンロードしたJSONを確認:
- `errors`: フリーズ・エラー情報（`type: 'FREEZE'`に注目）
- `fps`: FPS推移（急落ポイントを特定）
- `events`: 操作履歴（フリーズ直前の操作を確認）

### 3. 修正タスクに追記
ログから判明した情報を修正タスクに追加:
- フリーズ発生タイミング（開始から何秒後）
- 直前の操作（何をしたらフリーズしたか）
- FPS推移パターン（徐々に低下 or 突然0）

### フリーズログの確認（ブラウザコンソール）
```javascript
showFreezeLogs()  // フリーズ情報をテーブル表示
```

## WASMデプロイ

### 自動リビルド（推奨）
```bash
./watch-wasm.sh
```
ファイル変更を監視して自動的にWASMをビルド・デプロイする。
- `src/`, `Cargo.toml`, `assets/` を監視
- 変更検知後500ms待機して実行（連続保存対策）
- Ctrl+C で終了

### 手動デプロイ
```bash
./deploy-wasm.sh
```

### アクセスURL
- ローカル: http://10.13.1.1:8080
- Tailscale: http://100.84.170.32:8080

## 次の作業

### プレイ確認不要（AIだけで完結）

#### 1. ワインディング順序の修正（パフォーマンス向上）✅完了
**結果**: 全6面の頂点順序をCCW（反時計回り）に修正、両面レンダリングを無効化
**効果**: GPU負荷半減（バックフェースカリング有効化）

#### 2. E2Eテスト拡充（基本操作の検証）✅完了
**追加したテスト**:
- ホットバー選択（1-9キー）
- ブロック設置によるインベントリ消費
- UI開閉（Eキー/ESCキー）
- フレーム安定性テスト（100フレームシミュレーション）
- ブロック破壊の連続実行

#### 3. cargo clippy警告を全て解消 ✅完了
- 未使用メソッドに`#[allow(dead_code)]`追加
- Range::containsへのリファクタリング
- too_many_arguments警告を抑制

#### 4. main.rsのモジュール分割 ✅完了
- `constants.rs`: 定数を外部ファイルに分離
- `block_type.rs`: BlockType enumを外部ファイルに分離
- main.rsから参照、3306行→3250行

#### 5. ユニットテストのカバレッジ確認・拡充 ✅完了
- 23テスト（ユニット11 + E2E12）すべて成功

#### 6. WASMビルドの自動テスト ✅完了
- GitHub Actions CI設定（.github/workflows/ci.yml）
- test / clippy / wasm の3ジョブ

#### 7. README整備 ✅完了
- ビルド方法、起動方法、操作説明、ゲーム目標を記載

#### 8. デバッグ用コマンド追加 ✅完了
- F3キーでデバッグHUDトグル
- FPS、プレイヤー座標、チャンク数を表示

#### 9. ログ出力の整理 ✅完了
- println!は既に存在しない（整理済み）

#### 10. エラーハンドリング改善
- unwrap()をexpect()やResult処理に置換

#### 11. 設定ファイル外出し
- config.toml（視野角、マウス感度、VIEW_DISTANCE等）
- ハードコードされた値を設定化

### プレイ確認必要

#### 12. 実プレイで他のバグがないか確認

## 開発フロー

```
ユーザー: ローカルで修正 → プッシュ
    ↓
AI: プルしてから作業開始
    ↓
AI: 作業完了 → プッシュ
    ↓
ユーザー: プルして確認
```

**ポイント**:
- ユーザーの修正は必ずプッシュしてからAIに依頼
- AIは作業前に必ず最新をプル
- コンフリクト防止のため同時編集を避ける

## 並列作業（Git Worktree）

サブエージェントとworktreeを組み合わせて並列作業を行う。

### ユースケース1: 複数アプローチの比較
パフォーマンス最適化などで異なる手法を試す場合:

```bash
git worktree add ../idle_factory_opt1 -b opt/approach-a
git worktree add ../idle_factory_opt2 -b opt/approach-b
# → 各worktreeでサブエージェントが実装・ベンチマーク
# → 結果比較、最良をmainにマージ
```

### ユースケース2: 複数機能の並列実装
独立した機能を同時に実装する場合:

```bash
git worktree add ../idle_factory_feat1 -b feat/power-system
git worktree add ../idle_factory_feat2 -b feat/liquid-pipes
# → 各worktreeでサブエージェントが実装
# → 完了順にmainへマージ
```

### 共通フロー
```bash
# 作業完了後は即座にクリーンアップ
git worktree remove ../idle_factory_xxx
git branch -d feat/xxx  # または -D で強制削除
```

**使用条件**:
- 互いに独立した作業（コンフリクトしない）
- 並列化の恩恵がある（ビルド時間、待ち時間の削減）

**注意**: target/が各worktreeで生成されるためディスク消費大

## サブエージェント活用

コンテキスト共有が必要な並列作業にはサブエージェントを使用。

### 使い分け

| 手法 | 適したケース |
|------|-------------|
| Git Worktree | ファイルが独立、後でマージ可能 |
| サブエージェント | 同じルール参照、出力の整合性が必要 |

### サブエージェントが適切な例
- **3Dモデル生成**: 複数モデルを同じスタイルで作成
- **UI実装**: 同じデザインルールで複数画面
- **テスト作成**: 同じテストパターンで複数モジュール
- **リファクタリング**: 同じパターンを複数ファイルに適用

### 使用方法
```
# 並列でサブエージェントを起動（Taskツール）
Task 1: 「ハンマーの3Dモデルを作成。modeling-rules.md参照」
Task 2: 「コンベアの3Dモデルを作成。modeling-rules.md参照」
Task 3: 「精錬炉の3Dモデルを作成。modeling-rules.md参照」
→ 同時に起動、各自がルールを読んで作業
```

### 判断基準
- 別ファイルを編集 & 後でマージ可能 → **Worktree**
- 同じ設定参照 & 出力の整合性必要 → **サブエージェント**

## 将来のアイデア（実装しない）

| アイデア | メモ |
|----------|------|
| Discord連携 | ゲーム専用チャンネルのログをIssue化、フィードバック自動収集。レビューが増えたら検討 |
| CI/CD | mainプッシュ時にWASM自動ビルド。手動公開が面倒になったら検討 |

## 実プレイ確認後の計画

### フェーズ1: バグ修正（最優先）
- 実プレイで発見した問題を修正
- 操作感の調整（クリック判定、UI反応など）

### フェーズ2: ゲームループ拡充 ✅完了
- ~~銅鉱石・銅インゴット追加~~
- ~~新機械1つ（粉砕機 or プレス機）~~
- ~~クエスト3-4追加~~

### フェーズ3: 選択肢（どれか1つ）
1. 電力システム（機械に電力要求）
2. 液体・パイプ（燃料、冷却材）
3. スプリッター（コンベア分岐）

### 後回し
- チュートリアルポップアップ
- ガイドマーカー
- 資源バイオーム

**原則**: 遊べる状態を維持しながら機能追加

## ビルド最適化（80コア環境）

### 設定ファイル

**.cargo/config.toml**:
```toml
[build]
jobs = 80
rustc-wrapper = "/home/bacon/.cargo/bin/sccache"

[target.x86_64-unknown-linux-gnu]
linker = "clang"
rustflags = ["-C", "link-arg=-fuse-ld=mold"]
```

**Cargo.toml**:
```toml
[profile.release]
opt-level = 3
lto = "thin"
codegen-units = 16
strip = true
```

### 必要なツール
```bash
sudo apt-get install -y mold
cargo install sccache --locked
```

### ビルド時間

| ビルド | 最適化前 | キャッシュ後 |
|--------|----------|-------------|
| ネイティブ Release | 2分5秒 | **55秒** |
| WASM | 2分13秒 | **7秒** |

### 仕組み
- **jobs = 80**: 80コア並列コンパイル
- **sccache**: コンパイル結果をキャッシュ（リビルド高速化）
- **mold**: 高速リンカー（リンク時間短縮）
- **codegen-units = 16**: 並列コード生成

## よくあるバグと対策

### 地面が透ける（黒い穴）
**原因**: メッシュのワインディング順序が間違っている
**症状**: 地面や壁に黒い穴が見える（バックフェースカリングで消える）
**自動検出**: pre-commitフックで `src/main.rs` 変更時に自動テスト
**手動検出**: `cargo test test_mesh_winding_order`
**対策**: 面定義の頂点順序を修正（`cross(v1-v0, v2-v0)` が法線方向を向くように）

```
正しい順序の確認方法:
1. 三角形の3頂点 v0, v1, v2 を取得
2. edge1 = v1 - v0, edge2 = v2 - v0
3. cross(edge1, edge2) が法線と同じ方向なら正しい
```

**ファイル**: `src/main.rs` の `generate_mesh_with_neighbors` 内の `faces` 配列

## 作業ログ

### 2025-12-27
- **ワインディング順序の修正（パフォーマンス向上）**
  - 全6面の頂点順序をCCW（反時計回り）に修正
  - `double_sided: true, cull_mode: None`を削除（4箇所）
  - バックフェースカリング有効化でGPU負荷半減
- **E2Eテスト拡充**
  - ホットバー選択テスト追加
  - ブロック設置によるインベントリ消費テスト追加
  - UI開閉テスト追加（Eキー/ESCキー）
  - フレーム安定性テスト追加（100フレームシミュレーション）
  - ブロック破壊の連続実行テスト追加
  - テスト総数: 11 → 23（ユニット11 + E2E12）
- **cargo clippy警告を全て解消**
  - 未使用メソッド（`index_to_pos`, `has_block_at`, `is_machine`, `can_add_input`）に`#[allow(dead_code)]`追加
  - Range::containsへのリファクタリング（6箇所）
  - `#[allow(clippy::too_many_arguments)]`追加（`player_look`, `block_break`）
- **3つのバグを修正**
  - ブロック設置時のフリーズ: block_placeのchunk再生成パターンをblock_breakと統一
  - 採掘機の視覚的フィードバック: miner_visual_feedbackシステム追加（パルスアニメーション）
  - デフォルト機械の破壊: block_breakにCrusher/Furnaceのレイキャスト追加
- **機械設置時の透ける問題を修正（再修正）** ✅確認済み
  - 原因: 機械設置時に`set_block(place_pos, BlockType::Stone)`で偽の石ブロックを登録していた
  - 修正: 機械（Miner, Conveyor, Crusher）設置時は`set_block`を呼ばない
  - 機械は独自エンティティなのでワールドデータ登録不要
- **block_placeのマテリアル設定を統一**
  - `StandardMaterial::default()`を使用していた箇所を修正
  - `double_sided: true, cull_mode: None`に統一
- **カメラ回転の滑らかさ改善** ✅確認済み
  - 原因: `MAX_REASONABLE_DELTA = 200.0`が低すぎて高速マウス移動がフィルタリングされていた
  - 修正: `MAX_REASONABLE_DELTA = 500.0`に変更
- **バグ修正3件**
  - 空スロット(8,9)を数字キーで選択可能に（選択解除として動作）
  - 機械設置時の地面透け問題を修正（WorldDataにブロック登録してチャンク再生成）
  - 採掘機を無限資源生成に変更（地面を掘らず、下のブロックタイプに応じて資源生成）
- **ビルド最適化（80コア環境）**
  - sccache導入でコンパイルキャッシュ
  - moldリンカーで高速リンク
  - codegen-units=16で並列コード生成
  - ネイティブ: 2分5秒→55秒、WASM: 2分13秒→7秒
- **ブロック掘削後の透ける問題を修正** ✅確認済み
  - ~~両面レンダリング（double_sided: true, cull_mode: None）で対処~~
  - ワインディング順序を修正し、バックフェースカリング再有効化済み（上記参照）
- **チャンク生成パフォーマンス改善**
  - ChunkData: HashMapから配列ベースの実装に変更
  - メッシュ生成: Y-Z-Xループ順でキャッシュ効率向上
  - 事前メモリ割り当て: Vec::with_capacity使用
  - VIEW_DISTANCE: ネイティブ2→3、WASM1→2に増加
  - フレームあたりのチャンク生成数: 2→4に増加
  - CHUNK_HEIGHT定数を追加（8固定）
- **WASM対応を準備**
  - Cargo.tomlにWASM用条件付き依存関係を追加
  - main.rsでPipelinedRenderingPluginを条件付きコンパイル
  - .cargo/config.tomlにgetrandom設定
  - web/index.html、build-wasm.shを作成
  - WASMビルド成功（wasm-bindgenはローカルで実行必要）

### 2025-12-26
- **クエストシステムを実装**
  - QuestDef: 目標アイテム、必要数、報酬を定義
  - CurrentQuestリソース: 進捗状態を管理
  - Quest 1: 鉄インゴット3個納品 → 採掘機×2, コンベア×20
  - Quest 2: 鉄インゴット100個納品 → 採掘機×2, コンベア×40
  - 画面上部中央にクエストUI表示
  - Q キーで報酬受け取り
  - 全15テスト成功
- **納品プラットフォームを実装**
  - DeliveryPlatformコンポーネント（delivered: HashMap<BlockType, u32>）
  - 12×12の緑色プラットフォーム（位置: 20,8,10）
  - 16個の黄色ポートマーカー（辺に4個ずつ）
  - コンベアからアイテム受け取りロジック
  - 右上に納品数UIを表示
  - 全15テスト成功
- **採掘機・コンベアの設置機能を実装**
  - BlockType: MinerBlock, ConveyorBlock追加
  - block_place: 機械設置に対応（Miner, Conveyorコンポーネント自動付与）
  - yaw_to_direction: プレイヤー視線→コンベア向き変換
  - 初期インベントリ: 採掘機×3, コンベア×10追加
  - 右クリックで向いている方向にコンベアを設置
- **採掘機・コンベアを実装**
  - Minerコンポーネント（position, progress, buffer）
  - Conveyorコンポーネント（position, direction, item, progress）
  - Direction列挙型（North, South, East, West）
  - miner_mining: 5秒ごとに下のブロックを採掘、バッファに保持
  - miner_output: 隣接コンベアにアイテム出力
  - conveyor_transfer: コンベアチェーンでアイテム移動、精錬炉に自動投入
  - デモ配置: Miner(5,8,15) → Conv(6,8,15) → Conv(7,8,15) → Furnace(8,8,15)
  - 全15テスト成功
- **精錬炉を実装**
  - BlockType: IronOre, Coal, IronIngot追加
  - Furnaceコンポーネント（fuel, input, output, progress）
  - 初期アイテム（鉄鉱石×5, 石炭×5）
  - Eキーで精錬炉UI表示（見ている精錬炉をターゲット）
  - 精錬ロジック（3秒で1個精錬、燃料+原料→鉄インゴット）
  - 進捗バー付きUI
- **複数チャンク対応を実装**
  - `WorldData`リソースで複数チャンクを管理
  - プレイヤー周囲5x5チャンク（VIEW_DISTANCE=2）を動的ロード/アンロード
  - 座標変換（ワールド↔チャンク↔ローカル）
  - テスト10件追加、全15件パス
- **run.sh修正**
  - パスを`/home/bacon/idle_factory`に修正
  - Xvfb自動検出を追加
  - `source ~/.cargo/env`を追加
- **libxkbcommon-x11-0インストール**（Bevy起動に必要）

## ユーザー確認待ちリスト

### 複数チャンク対応（2025-12-26）✅確認済み

### ブロック設置機能（2025-12-27）✅確認済み
- [x] 右クリックでブロック設置ができる
- [x] 設置時にインベントリから消費される
- [x] 既存の機械と同じ位置には設置できない

### ホットバーUI（2025-12-27）✅確認済み
- [x] 画面下部中央に9スロットのホットバーが表示される
- [x] 1-9キーでスロットを選択できる（空スロット含む）
- [x] 選択中のスロットがハイライトされる
- [x] 数量が表示される

### 精錬炉（2025-12-26）✅確認済み
- [x] 精錬炉を見てEキーでUIが開く
- [x] 精錬は正常に動作
- [x] ESCでUIを閉じた時にカーソルが正常に戻る

### 採掘機・コンベア設置（2025-12-27）
- [x] インベントリに採掘機×3、コンベア×10、粉砕機×2がある
- [ ] 右クリックで採掘機を設置できるか
- [ ] 右クリックでコンベアを設置できるか（向いている方向に向く）
- [ ] 設置した採掘機が無限に資源を生成するか（地面を掘らない）
- [ ] 設置したコンベアがアイテムを運ぶか
- [ ] 機械設置時に地面が透けないか

### 納品プラットフォーム（2025-12-26）
- [x] 緑色の12×12プラットフォームが見える
- [x] 黄色のポートマーカーが見える
- [ ] コンベアをプラットフォームに接続するとアイテムが納品されるか
- [ ] 納品数がUIに反映されるか

### クエストシステム（2025-12-26）✅確認済み
- [x] 画面上部中央に「Quest」UIが表示されている
- [ ] 鉄インゴットを納品すると進捗が更新されるか
- [ ] 3個納品で報酬を受け取れるか

### パフォーマンス改善（2025-12-27）
- [ ] ネイティブ版で120FPS以上出るか（GPU環境で確認）
- [ ] VIEW_DISTANCE=3（7x7=49チャンク）で遠くまで見えるか
- [ ] チャンク読み込み時のカクつきが軽減されたか

### WASMプレイ確認
- **URL**: http://100.84.170.32:8080 (Tailscale)
- [ ] ブラウザでゲームが起動するか
- [ ] 操作（WASD移動、マウス視点）が効くか
- [ ] FPSが30以上出るか（画面上部のタイトルで確認）
- [ ] ブロック採掘・設置ができるか

**デプロイ手順**:
```bash
./deploy-wasm.sh  # ビルド＆サーバー再起動
```

## 参照ファイル

| ファイル | 用途 |
|----------|------|
| `API_REFERENCE.md` | 関数・構造体 |
| `.specify/specs/` | 仕様（実装対象） |
| `.specify/roadmap.md` | 将来機能（実装しない） |
| `.specify/memory/modeling-rules.md` | 3Dモデル |
| `.specify/memory/ui-design-rules.md` | UI実装時 |
