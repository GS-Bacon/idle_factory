# Claude Code メモリ

## 批判的姿勢（重要）

ユーザーの提案に対しても以下を確認し、問題があれば指摘する:
- 仕様地獄に戻っていないか？（詳細化・レビュー・パターン確認の連鎖）
- メタワークになっていないか？（ゲームを作らず道具を作っている）
- 実装より仕様が先行していないか？
- 「完璧」を目指して「完成」を遅らせていないか？

**過去の失敗**: 仕様39ファイル・パターン52個・レビュースキル群を作り、誰もゲームを遊んでいなかった

## 基本ルール

| ルール | 詳細 |
|--------|------|
| テスト | 実装後は `cargo test` と `cargo clippy` |
| コミット | 日本語メッセージ、適宜コミット、pushは指示待ち |
| 中断禁止 | 確認を求めず最後まで完了 |
| 動作確認 | E2Eテストで基本動作を検証 |
| ゲーム起動 | `./run.sh` を使用（RDPディスプレイ自動検出） |
| Gemini CLI | `gemini -m gemini-3-pro-preview -p "プロンプト"` を使用 |
| Gemini活用 | 3Dモデリング・座標計算・幾何学処理で精度検証中。効果確認後に本格採用 |

## 検証の分担

| 担当 | 内容 |
|------|------|
| AI | ビルド、テスト、E2E、クリック反応、UI動作 |
| 人間 | ゲームプレイ体験（面白さ、直感性） |

**AIが確認すべき**: 「クリックしても反応しない」等の技術的バグ
**人間が確認すべき**: 「遊んでいて楽しいか」等の体験

## 禁止事項

- 仕様だけのセッション2回連続
- パターン集の事前確認（問題が起きたら見る）
- レビュー・評価スキルの使用
- ドキュメント整理・圧縮作業

## 却下済みの提案（再提案時は指摘する）

| 提案 | 却下理由 |
|------|----------|
| 定期レビュー導入 | メタワーク復活の入口。問題が起きたらで十分 |
| TDD導入 | 「テストが通る」が目的化する。実装後テストで十分 |
| プロセス追加 | Milestone 1-2は規模が小さい。E2Eで十分 |

**導入検討タイミング**: Milestone 3以降、または問題が頻発したとき

## マイルストーン駆動

```
仕様（1ページ）→ 実装 → 動かして確認 → 次へ
```

「done」= テストが通る、ではなく「遊べる」

## 3Dモデル生成

「〇〇のモデルを作成」指示で:
1. `.specify/memory/modeling-rules.md` 参照
2. サブエージェント起動
3. 完了報告

## 実プレイ検証

実プレイ検証は後回しにし、ユーザーが確認することリストにまとめる。

## プレイテストフィードバック

ユーザーからフィードバックを受けたら:
1. `/tmp/wasm-game-sessions.jsonl` の該当セッションを確認
2. FPS推移、エラー、操作パターンをチェック
3. ユーザーの報告 + ログからの発見を合わせてバグ修正

```bash
# 直近のログを確認
cat /tmp/wasm-game-sessions.jsonl | tail -3 | jq .
```

## WASMデプロイ

### 手動デプロイ
```bash
./deploy-wasm.sh
```

### アクセスURL
- ローカル: http://10.13.1.1:8080
- Tailscale: http://100.84.170.32:8080

### コミット後の運用
1. コードを変更・コミット
2. `./deploy-wasm.sh` を実行（WASMビルド＆サーバー再起動）
3. ブラウザをリロードして確認

## 次の作業

1. ワインディング順序を修正してカリング再有効化（パフォーマンス向上）
2. 実プレイで他のバグがないか確認

## 開発フロー

```
ユーザー: ローカルで修正 → プッシュ
    ↓
AI: プルしてから作業開始
    ↓
AI: 作業完了 → プッシュ
    ↓
ユーザー: プルして確認
```

**ポイント**:
- ユーザーの修正は必ずプッシュしてからAIに依頼
- AIは作業前に必ず最新をプル
- コンフリクト防止のため同時編集を避ける

## 将来のアイデア（実装しない）

| アイデア | メモ |
|----------|------|
| Discord連携 | ゲーム専用チャンネルのログをIssue化、フィードバック自動収集。レビューが増えたら検討 |
| CI/CD | mainプッシュ時にWASM自動ビルド。手動公開が面倒になったら検討 |

## 実プレイ確認後の計画

### フェーズ1: バグ修正（最優先）
- 実プレイで発見した問題を修正
- 操作感の調整（クリック判定、UI反応など）

### フェーズ2: ゲームループ拡充 ✅完了
- ~~銅鉱石・銅インゴット追加~~
- ~~新機械1つ（粉砕機 or プレス機）~~
- ~~クエスト3-4追加~~

### フェーズ3: 選択肢（どれか1つ）
1. 電力システム（機械に電力要求）
2. 液体・パイプ（燃料、冷却材）
3. スプリッター（コンベア分岐）

### 後回し
- チュートリアルポップアップ
- ガイドマーカー
- 資源バイオーム

**原則**: 遊べる状態を維持しながら機能追加

## 作業ログ

### 2025-12-27
- **ブロック掘削後の透ける問題を修正** ✅確認済み
  - 両面レンダリング（double_sided: true, cull_mode: None）で対処
  - 根本原因は面のワインディング順序（頂点の定義順）の可能性
  - ワインディング順序: 三角形の頂点を時計回り/反時計回りで定義する順番
  - Bevyデフォルトは反時計回り（CCW）が表面
  - TODO: ワインディング修正してカリング再有効化（GPU負荷半減）
- **チャンク生成パフォーマンス改善**
  - ChunkData: HashMapから配列ベースの実装に変更
  - メッシュ生成: Y-Z-Xループ順でキャッシュ効率向上
  - 事前メモリ割り当て: Vec::with_capacity使用
  - VIEW_DISTANCE: ネイティブ2→3、WASM1→2に増加
  - フレームあたりのチャンク生成数: 2→4に増加
  - CHUNK_HEIGHT定数を追加（8固定）
- **WASM対応を準備**
  - Cargo.tomlにWASM用条件付き依存関係を追加
  - main.rsでPipelinedRenderingPluginを条件付きコンパイル
  - .cargo/config.tomlにgetrandom設定
  - web/index.html、build-wasm.shを作成
  - WASMビルド成功（wasm-bindgenはローカルで実行必要）

### 2025-12-26
- **クエストシステムを実装**
  - QuestDef: 目標アイテム、必要数、報酬を定義
  - CurrentQuestリソース: 進捗状態を管理
  - Quest 1: 鉄インゴット3個納品 → 採掘機×2, コンベア×20
  - Quest 2: 鉄インゴット100個納品 → 採掘機×2, コンベア×40
  - 画面上部中央にクエストUI表示
  - Q キーで報酬受け取り
  - 全15テスト成功
- **納品プラットフォームを実装**
  - DeliveryPlatformコンポーネント（delivered: HashMap<BlockType, u32>）
  - 12×12の緑色プラットフォーム（位置: 20,8,10）
  - 16個の黄色ポートマーカー（辺に4個ずつ）
  - コンベアからアイテム受け取りロジック
  - 右上に納品数UIを表示
  - 全15テスト成功
- **採掘機・コンベアの設置機能を実装**
  - BlockType: MinerBlock, ConveyorBlock追加
  - block_place: 機械設置に対応（Miner, Conveyorコンポーネント自動付与）
  - yaw_to_direction: プレイヤー視線→コンベア向き変換
  - 初期インベントリ: 採掘機×3, コンベア×10追加
  - 右クリックで向いている方向にコンベアを設置
- **採掘機・コンベアを実装**
  - Minerコンポーネント（position, progress, buffer）
  - Conveyorコンポーネント（position, direction, item, progress）
  - Direction列挙型（North, South, East, West）
  - miner_mining: 5秒ごとに下のブロックを採掘、バッファに保持
  - miner_output: 隣接コンベアにアイテム出力
  - conveyor_transfer: コンベアチェーンでアイテム移動、精錬炉に自動投入
  - デモ配置: Miner(5,8,15) → Conv(6,8,15) → Conv(7,8,15) → Furnace(8,8,15)
  - 全15テスト成功
- **精錬炉を実装**
  - BlockType: IronOre, Coal, IronIngot追加
  - Furnaceコンポーネント（fuel, input, output, progress）
  - 初期アイテム（鉄鉱石×5, 石炭×5）
  - Eキーで精錬炉UI表示（見ている精錬炉をターゲット）
  - 精錬ロジック（3秒で1個精錬、燃料+原料→鉄インゴット）
  - 進捗バー付きUI
- **複数チャンク対応を実装**
  - `WorldData`リソースで複数チャンクを管理
  - プレイヤー周囲5x5チャンク（VIEW_DISTANCE=2）を動的ロード/アンロード
  - 座標変換（ワールド↔チャンク↔ローカル）
  - テスト10件追加、全15件パス
- **run.sh修正**
  - パスを`/home/bacon/idle_factory`に修正
  - Xvfb自動検出を追加
  - `source ~/.cargo/env`を追加
- **libxkbcommon-x11-0インストール**（Bevy起動に必要）

## ユーザー確認待ちリスト

### 複数チャンク対応（2025-12-26）✅確認済み

### ブロック設置機能（2025-12-27）
- [x] 右クリックでブロック設置ができる
- [ ] 設置時にインベントリから消費されるか
- [x] 既存の機械と同じ位置には設置できない（修正済み）

### ホットバーUI（2025-12-27）
- [ ] 画面下部中央に9スロットのホットバーが表示されるか
- [ ] 1-9キーでスロットを選択できるか
- [ ] 選択中のスロットがハイライトされるか
- [ ] アイテム名と数量が表示されるか

### 精錬炉（2025-12-26）
- [x] 精錬炉を見てEキーでUIが開く
- [x] 精錬は正常に動作
- [x] ESCでUIを閉じた時にカーソルが正常に戻る（修正済み）

### 採掘機・コンベア設置（2025-12-27）
- [ ] インベントリに採掘機×3、コンベア×10、粉砕機×2があるか
- [ ] 右クリックで採掘機を設置できるか
- [ ] 右クリックでコンベアを設置できるか（向いている方向に向く）
- [ ] 設置した採掘機が自動で下を掘るか
- [ ] 設置したコンベアがアイテムを運ぶか

### 納品プラットフォーム（2025-12-26）
- [x] 緑色の12×12プラットフォームが見える
- [x] 黄色のポートマーカーが見える
- [ ] コンベアをプラットフォームに接続するとアイテムが納品されるか
- [ ] 納品数がUIに反映されるか

### クエストシステム（2025-12-26）
- [ ] 画面上部中央に「Quest」UIが表示されているか
- [ ] 鉄インゴットを納品すると進捗が更新されるか
- [ ] 3個納品で報酬を受け取れるか

### パフォーマンス改善（2025-12-27）
- [ ] ネイティブ版で120FPS以上出るか（GPU環境で確認）
- [ ] VIEW_DISTANCE=3（7x7=49チャンク）で遠くまで見えるか
- [ ] チャンク読み込み時のカクつきが軽減されたか

### WASMプレイ確認
- **URL**: http://100.84.170.32:8080 (Tailscale)
- [ ] ブラウザでゲームが起動するか
- [ ] 操作（WASD移動、マウス視点）が効くか
- [ ] FPSが30以上出るか（画面上部のタイトルで確認）
- [ ] ブロック採掘・設置ができるか

**デプロイ手順**:
```bash
./deploy-wasm.sh  # ビルド＆サーバー再起動
```

## 参照ファイル

| ファイル | 用途 |
|----------|------|
| `API_REFERENCE.md` | 関数・構造体 |
| `.specify/specs/` | 仕様（実装対象） |
| `.specify/roadmap.md` | 将来機能（実装しない） |
| `.specify/memory/modeling-rules.md` | 3Dモデル |
| `.specify/memory/ui-design-rules.md` | UI実装時 |
