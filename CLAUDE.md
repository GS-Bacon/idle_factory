# Claude Code メモリ

## 批判的姿勢（重要）

ユーザーの提案に対しても以下を確認し、問題があれば指摘する:
- 仕様地獄に戻っていないか？（詳細化・レビュー・パターン確認の連鎖）
- メタワークになっていないか？（ゲームを作らず道具を作っている）
- 実装より仕様が先行していないか？
- 「完璧」を目指して「完成」を遅らせていないか？

**過去の失敗**: 仕様39ファイル・パターン52個・レビュースキル群を作り、誰もゲームを遊んでいなかった

## 基本ルール

| ルール | 詳細 |
|--------|------|
| テスト | 実装後は `cargo test` と `cargo clippy` |
| コミット | 日本語メッセージ、pushは指示待ち |
| 中断禁止 | 確認を求めず最後まで完了 |
| 動作確認 | E2Eテストで基本動作を検証 |
| ゲーム起動 | `./run.sh` を使用（RDPディスプレイ自動検出） |

## 検証の分担

| 担当 | 内容 |
|------|------|
| AI | ビルド、テスト、E2E、クリック反応、UI動作 |
| 人間 | ゲームプレイ体験（面白さ、直感性） |

**AIが確認すべき**: 「クリックしても反応しない」等の技術的バグ
**人間が確認すべき**: 「遊んでいて楽しいか」等の体験

## 禁止事項

- 仕様だけのセッション2回連続
- パターン集の事前確認（問題が起きたら見る）
- レビュー・評価スキルの使用
- ドキュメント整理・圧縮作業

## 却下済みの提案（再提案時は指摘する）

| 提案 | 却下理由 |
|------|----------|
| 定期レビュー導入 | メタワーク復活の入口。問題が起きたらで十分 |
| TDD導入 | 「テストが通る」が目的化する。実装後テストで十分 |
| プロセス追加 | Milestone 1-2は規模が小さい。E2Eで十分 |

**導入検討タイミング**: Milestone 3以降、または問題が頻発したとき

## マイルストーン駆動

```
仕様（1ページ）→ 実装 → 動かして確認 → 次へ
```

「done」= テストが通る、ではなく「遊べる」

## 3Dモデル生成

「〇〇のモデルを作成」指示で:
1. `.specify/memory/modeling-rules.md` 参照
2. サブエージェント起動
3. 完了報告

## 実プレイ検証

実プレイ検証は後回しにし、ユーザーが確認することリストにまとめる。

## 次の作業

1. プレイヤーによる採掘機・コンベアの設置機能

## 作業ログ

### 2025-12-26
- **採掘機・コンベアを実装**
  - Minerコンポーネント（position, progress, buffer）
  - Conveyorコンポーネント（position, direction, item, progress）
  - Direction列挙型（North, South, East, West）
  - miner_mining: 5秒ごとに下のブロックを採掘、バッファに保持
  - miner_output: 隣接コンベアにアイテム出力
  - conveyor_transfer: コンベアチェーンでアイテム移動、精錬炉に自動投入
  - デモ配置: Miner(5,8,15) → Conv(6,8,15) → Conv(7,8,15) → Furnace(8,8,15)
  - 全15テスト成功
- **精錬炉を実装**
  - BlockType: IronOre, Coal, IronIngot追加
  - Furnaceコンポーネント（fuel, input, output, progress）
  - 初期アイテム（鉄鉱石×5, 石炭×5）
  - Eキーで精錬炉UI表示（見ている精錬炉をターゲット）
  - 精錬ロジック（3秒で1個精錬、燃料+原料→鉄インゴット）
  - 進捗バー付きUI
- **複数チャンク対応を実装**
  - `WorldData`リソースで複数チャンクを管理
  - プレイヤー周囲5x5チャンク（VIEW_DISTANCE=2）を動的ロード/アンロード
  - 座標変換（ワールド↔チャンク↔ローカル）
  - テスト10件追加、全15件パス
- **run.sh修正**
  - パスを`/home/bacon/idle_factory`に修正
  - Xvfb自動検出を追加
  - `source ~/.cargo/env`を追加
- **libxkbcommon-x11-0インストール**（Bevy起動に必要）

## ユーザー確認待ちリスト

### 複数チャンク対応（2025-12-26）
- [ ] プレイヤー周囲に地形が生成されているか（5x5チャンク = 80x80ブロック）
- [ ] 歩いて遠くに行くと新しい地形が生成されるか
- [ ] 戻ると以前の地形が再度読み込まれるか
- [ ] ブロック破壊・設置がチャンク境界でも動作するか

### ブロック設置機能（2025-12-26）
- [ ] 右クリックでブロック設置ができるか
- [ ] 設置時にインベントリから消費されるか
- [ ] 1-2キーでブロック選択ができるか
- [ ] UIに選択中ブロックが表示されるか

### 精錬炉（2025-12-26）
- [ ] 初期インベントリに鉄鉱石×5、石炭×5があるか
- [ ] 精錬炉（茶色ブロック）がスポーン地点近くにあるか
- [ ] 精錬炉を見てEキーでUIが開くか
- [ ] [1]で石炭投入、[2]で鉄鉱石投入ができるか
- [ ] 燃料+原料がそろうと精錬が進むか（3秒で1個）
- [ ] [3]で鉄インゴットを取り出せるか
- [ ] Eキーで閉じれるか

### 採掘機・コンベア（2025-12-26）
- [ ] 採掘機（オレンジ色）がスポーン地点近く(5,8,15)にあるか
- [ ] コンベア（灰色の薄いブロック）が2つ並んでいるか
- [ ] 採掘機が自動で下のブロックを掘っているか（5秒ごと）
- [ ] 採掘したアイテムがコンベアに乗るか
- [ ] コンベアがアイテムを東方向に運ぶか
- [ ] コンベアの終端にある精錬炉にアイテムが自動投入されるか
- [ ] 精錬炉のUIで燃料/原料の数が増えているか

## 参照ファイル

| ファイル | 用途 |
|----------|------|
| `API_REFERENCE.md` | 関数・構造体 |
| `.specify/specs/` | 仕様（実装対象） |
| `.specify/roadmap.md` | 将来機能（実装しない） |
| `.specify/memory/modeling-rules.md` | 3Dモデル |
| `.specify/memory/ui-design-rules.md` | UI実装時 |
