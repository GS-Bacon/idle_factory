# Claude Code メモリ

## 互換性ポリシー

- **既存プレイヤーはいない** → セーブデータ移行は不要
- **しばらくは後方互換性を気にしなくてよい**
- 破壊的変更OK、古いセーブ切り捨てOK

## メタワーク判定基準（重要）

### メタワーク（やらない）

| 例 | 理由 |
|----|------|
| 仕様書を詳細化する | ゲームが1行も進まない |
| ドキュメント整理・圧縮 | 誰も読まない |
| ドキュメントコメント追加 | 誰も読まない |
| レビュースキル・パターン集作成 | 使わない道具 |
| コード移動だけのリファクタ | バグ確率変わらない |

### メタワークではない（やる）

| 例 | 理由 |
|----|------|
| 自動テスト追加 | バグを早期発見、開発速度UP |
| E2E強化 | 遊べないバグを防ぐ |
| CI/起動確認スクリプト | クラッシュを即検出 |
| バグ修正 | 遊べるようにする |
| リファクタ（複雑さ解消） | 将来のバグ確率を減らす |
| アーキテクチャ改善 | 機能追加時のバグ確率を減らす |
| 重複コード統合 | 片方だけ直して忘れるバグを防ぐ |
| 機能追加 | ゲームが進む |
| UI/UX改善 | 体験が良くなる |
| パフォーマンス改善 | 遊べる体験に直結 |

### 判定フロー

```
これをやると...
  → ゲームが遊べるようになる？ → やる
  → 今のバグが減る？ → やる
  → 将来のバグ確率が減る？ → やる
  → 機能追加が速くなる？ → やる
  → ドキュメントが増えるだけ？ → やらない
```

**過去の失敗**: 仕様39ファイル・パターン52個・レビュースキル群を作り、誰もゲームを遊んでいなかった

## 基本ルール

| ルール | 詳細 |
|--------|------|
| ビルド | `cargo build` (2秒)、テスト後 `cargo test && cargo clippy` |
| コミット | 日本語、短く。**コミットは自己判断でOK**、pushは指示待ち |
| 中断禁止 | 確認を求めず最後まで完了 |
| ゲーム起動 | `./run.sh` |
| バグ修正 | **必ずログ確認してから**。憶測での修正禁止 |

## 禁止事項

- 仕様だけのセッション2回連続
- 憶測での修正（ログ/スクリーンショットで確認してから）
- ドキュメント整理・圧縮作業

## 新機能実装

**確認が必要**: 新ゲーム要素、UI/UX変更、ゲームバランス変更
**確認不要**: バグ修正、リファクタリング、テスト追加

仕様は `src/game_spec.rs` に定義（Single Source of Truth）

## 検証の分担

| 担当 | 内容 |
|------|------|
| AI | ビルド、テスト、E2E、スクリーンショット確認、UI動作 |
| 人間 | ゲームプレイ体験（面白さ、直感性） |

## 開発フロー

```
ユーザー: 修正 → プッシュ → AI: プル → 作業 → プッシュ → ユーザー: 確認
```

## Gemini連携

**使用条件**: Gemini 3/2.5モデルの時のみ使用（トークン制限でモデル切り替わったら使わない）

### Claude vs Gemini 使い分け

| 観点 | Claude | Gemini |
|------|--------|--------|
| **強み** | コード詳細分析、安全性、リファクタリング | 俯瞰的アーキテクチャ、ツール評価 |
| **視点** | 「進捗」を評価 | 「現状の課題」を厳しく指摘 |
| **具体性** | 行番号付きの具体的指摘 | 理想形のコード例を提示 |
| **速度** | 即座に回答 | ファイル読み込みに時間がかかる |

### タスク別の使い分け

| タスク | 使うAI | 理由 |
|--------|--------|------|
| 新機能のアーキテクチャ設計 | **Gemini** | 俯瞰的な設計が得意 |
| 実装コード | **Claude** | 詳細なコーディング |
| コードレビュー | **両方** | 比較して精度向上 |
| バグ修正 | **Claude** | ログ・詳細分析 |
| リファクタリング計画 | **Gemini** | 全体像の把握 |
| リファクタリング実行 | **Claude** | コード変更 |

### Geminiが得意なこと

| 用途 | 例 |
|------|-----|
| アーキテクチャ設計 | Plugin構成、モジュール分割の提案 |
| ベストプラクティス | Bevy公式パターンとの比較 |
| 俯瞰レビュー | 12,000行全体の構造評価 |
| CI/CDツール評価 | スクリプト、自動化の評価 |
| 空間・ベクトル計算の検証 | 回転行列、座標変換、方向計算 |
| 数学的な正しさの確認 | 三角関数、線形代数 |

### Claudeが得意なこと

| 用途 | 例 |
|------|-----|
| unwrap()安全化 | パターンマッチングの提案 |
| リファクタリング差分 | 変更前後の比較 |
| バグ特定 | ログやスタックトレースからの推論 |
| コードの細部 | 命名、型、エラーハンドリング |

### 使い方

```bash
# 基本：質問のみ
./scripts/ask_gemini.sh "Rustのunwrap()の代替を3つ挙げて"

# ファイル指定（コンテキスト付き）
./scripts/ask_gemini.sh "このコードをレビューして" src/main.rs

# 複数ファイル指定
./scripts/ask_gemini.sh "アーキテクチャを評価して" src/*.rs

# パイプで質問
echo "質問内容" | ./scripts/ask_gemini.sh

# タイムアウト変更（デフォルト120秒）
GEMINI_TIMEOUT=180 ./scripts/ask_gemini.sh "詳細なレビュー" src/main.rs
```

### 連携パターン

| パターン | 手順 |
|----------|------|
| **設計レビュー** | Gemini→設計案→Claude→実装 |
| **バグ修正** | Claude→修正→Gemini→妥当性確認 |
| **リファクタリング** | Gemini→計画→Claude→実行→Gemini→レビュー |
| **数学計算** | Claude→コード→Gemini→計算検証 |

### ベストプラクティス

1. **大きな設計変更前**: Geminiに俯瞰レビューを依頼
2. **バグが取れない時**: Geminiにセカンドオピニオン
3. **座標・回転計算**: Geminiで数学的正しさを確認

### 注意点

- ファイル読み込みには30-60秒かかることがある
- 大きなファイル（1000行超）は応答が遅い
- タイムアウトが発生したら`GEMINI_TIMEOUT`を増やす

## 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| `.claude/implementation-plan.md` | **統合実装計画（タスク一覧）** |
| `.claude/architecture.md` | モジュール構成、依存関係、分割ルール |
| `.claude/coding-rules.md` | コーディング規約、命名規則 |
| `.claude/bugs.md` | よくあるバグと対策、チェックリスト |
| `.claude/build.md` | ビルド最適化、プロファイル設定 |
| `.specify/memory/input-rules.md` | 入力マトリクス |
| `.specify/memory/modeling-rules.md` | 3Dモデル作成ルール |
| `scripts/ask_gemini.sh` | Gemini質問スクリプト |
| `scripts/watch_gemini.sh` | Gemini出力監視スクリプト |

## 修正済みバグ

BUG-1〜9: 全て修正済み。詳細は `.claude/bugs.md` 参照。

## 現在の状態

| 項目 | 値 |
|------|-----|
| コード行数 | **10,957行** (目標12,500行以下 ✅) |
| テスト | **113件** 通過 |
| unwrap() | **17箇所** |
| Clippy警告 | **0件** |

## タスク

**詳細は `.claude/implementation-plan.md` 参照**

### 優先順位

| 順位 | カテゴリ | 状態 |
|------|----------|------|
| 1 | パフォーマンス改善 | Phase 1 |
| 2 | セキュリティ・エラー処理 | Phase 2 |
| 3 | v0.2機能実装 | Phase 3 |
| 4 | テスト強化 | Phase 4 |
| 5 | コードダイエット | Phase 5 |

### 次のアクション

1. **Phase 1**: highlight.rs + conveyor.rs パフォーマンス改善
2. **Phase 2**: unwrap()削除
3. **Phase 3**: v0.2機能（UI改修、クエスト拡張、機械入出力）

### 将来機能 (v0.3以降)

- リプレイシステム
- ブループリント
- 電力システム
- 流体パイプ
- マルチプレイ基盤
- Modding API
- ビジュアルプログラミング
