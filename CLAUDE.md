# Claude Code メモリ

## 批判的姿勢（重要）

- 仕様地獄に戻っていないか？（詳細化・レビュー・パターン確認の連鎖）
- メタワークになっていないか？（ゲームを作らず道具を作っている）
- 「完璧」を目指して「完成」を遅らせていないか？

**過去の失敗**: 仕様39ファイル・パターン52個・レビュースキル群を作り、誰もゲームを遊んでいなかった

## 基本ルール

| ルール | 詳細 |
|--------|------|
| ビルド | `cargo build` (2秒)、テスト後 `cargo test && cargo clippy` |
| コミット | 日本語、短く。**コミットは自己判断でOK**、pushは指示待ち |
| 中断禁止 | 確認を求めず最後まで完了 |
| ゲーム起動 | `./run.sh` |
| バグ修正 | **必ずログ確認してから**。憶測での修正禁止 |

## 禁止事項

- 仕様だけのセッション2回連続
- 憶測での修正（ログ/スクリーンショットで確認してから）
- ドキュメント整理・圧縮作業

## 新機能実装

**確認が必要**: 新ゲーム要素、UI/UX変更、ゲームバランス変更
**確認不要**: バグ修正、リファクタリング、テスト追加

仕様は `src/game_spec.rs` に定義（Single Source of Truth）

## 検証の分担

| 担当 | 内容 |
|------|------|
| AI | ビルド、テスト、E2E、スクリーンショット確認、UI動作 |
| 人間 | ゲームプレイ体験（面白さ、直感性） |

## 開発フロー

```
ユーザー: 修正 → プッシュ → AI: プル → 作業 → プッシュ → ユーザー: 確認
```

## 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| `.claude/architecture.md` | モジュール構成、依存関係、分割ルール |
| `.claude/coding-rules.md` | コーディング規約、命名規則 |
| `.claude/bugs.md` | よくあるバグと対策、チェックリスト |
| `.claude/build.md` | ビルド最適化、プロファイル設定 |
| `.claude/refactoring-tasks.md` | リファクタリングタスク（2026-01-01レビュー） |
| `.specify/memory/input-rules.md` | 入力マトリクス |
| `.specify/memory/modeling-rules.md` | 3Dモデル作成ルール |

## 修正済みバグ

BUG-1〜9: 全て修正済み。詳細は `.claude/bugs.md` 参照。

## 現在の状態

- v0.1 MVP: 完了
- フェーズ1-8: 全完了
- テスト: 91件通過

## タスクリスト

### 🔴 リファクタリング（高優先度）

詳細は `.claude/refactoring-tasks.md` 参照

| タスク | 状態 | 効果 |
|--------|------|------|
| block_operations.rs 分割 | ⬜ | 1001行→3ファイル |
| ui_setup.rs 分割 | ⬜ | 977行→3ファイル |
| MachineSystemsPlugin 作成 | ⬜ | main.rs 300行削減 |

### バグ修正・クリーンアップ
- [ ] vox_loader.rs:290 - unwrap()をOptionハンドリングに修正
- [ ] block_operations.rs:450 - unwrap()をOptionハンドリングに修正
- [ ] 未使用コード削除: Direction::opposite(), Conveyor::calculate_shape*, CreativeViewMode, CreativeCategory

### 自動バグ検出
- [ ] Lv1: Fuzzingスクリプト作成（ランダム入力でクラッシュ検出）
- [ ] Lv2: シナリオテスト追加（採掘機→コンベア→精錬炉→インゴット確認）
- [ ] Lv2: e2e_state.jsonに機械状態・インベントリ内容を追加
- [ ] Lv2: assert関数追加（assert_inventory_contains, assert_machine_working等）

### E2E改善（ゲーム内コマンド）
- [ ] /testコマンド追加（ゲーム内テストシナリオ実行）
- [ ] /assertコマンド追加（インベントリ・機械状態の検証）
- [ ] /spawn_lineコマンド追加（機械ラインを一発配置）

### ログ改善
- [ ] ゲームイベントログ追加（機械動作、プレイヤー操作、アイテム移動）
- [ ] 構造化ログ形式（JSON）に変更
- [ ] チャンク生成ログのノイズ削減（DEBUGレベルに下げる）

### ログ活用（AI連携）
- [ ] ログサマリー生成スクリプト（AIで自然言語要約）
- [ ] 異常検出ルール追加（機械停止、コンベア詰まり等）

### コンベア左右逆問題
- [ ] /debug_conveyorコマンド追加（pos, direction, shape, inputs, outputs, items出力）
- [ ] L字配置自動テスト（左曲がり/右曲がりのアイテム座標追跡）
- [ ] 「左」の定義統一（コード/モデル/アニメーションで同じ意味に）

### 将来リスト
- [ ] リプレイシステム: 操作記録・巻き戻し・早送り対応
- [ ] ブループリント: 範囲選択保存・ペースト・エクスポート/インポート
- [ ] 電力システム: 発電機・電線・電力消費・過負荷制御
- [ ] 流体パイプ: ポンプ・パイプ・タンク・流量計算
- [ ] マルチプレイ基盤: WebSocket同期・プレイヤー位置・ブロック操作同期
- [ ] Modding API: Lua/WASM埋め込み・イベントフック
- [ ] ビジュアルプログラミング: ノードグラフで機械の振る舞い定義
