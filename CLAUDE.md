# Claude Code メモリ

## 批判的姿勢（重要）

- 仕様地獄に戻っていないか？（詳細化・レビュー・パターン確認の連鎖）
- メタワークになっていないか？（ゲームを作らず道具を作っている）
- 「完璧」を目指して「完成」を遅らせていないか？

**過去の失敗**: 仕様39ファイル・パターン52個・レビュースキル群を作り、誰もゲームを遊んでいなかった

## 基本ルール

| ルール | 詳細 |
|--------|------|
| ビルド | `cargo build` (2秒)、テスト後 `cargo test && cargo clippy` |
| コミット | 日本語、短く。**コミットは自己判断でOK**、pushは指示待ち |
| 中断禁止 | 確認を求めず最後まで完了 |
| ゲーム起動 | `./run.sh` |
| バグ修正 | **必ずログ確認してから**。憶測での修正禁止 |

## 禁止事項

- 仕様だけのセッション2回連続
- 憶測での修正（ログ/スクリーンショットで確認してから）
- ドキュメント整理・圧縮作業

## 新機能実装

**確認が必要**: 新ゲーム要素、UI/UX変更、ゲームバランス変更
**確認不要**: バグ修正、リファクタリング、テスト追加

仕様は `src/game_spec.rs` に定義（Single Source of Truth）

## 検証の分担

| 担当 | 内容 |
|------|------|
| AI | ビルド、テスト、E2E、スクリーンショット確認、UI動作 |
| 人間 | ゲームプレイ体験（面白さ、直感性） |

## 開発フロー

```
ユーザー: 修正 → プッシュ → AI: プル → 作業 → プッシュ → ユーザー: 確認
```

## Gemini連携

**使用条件**: Gemini 3/2.5モデルの時のみ使用（トークン制限でモデル切り替わったら使わない）

### Claude vs Gemini 使い分け

| 観点 | Claude | Gemini |
|------|--------|--------|
| **強み** | コード詳細分析、安全性、リファクタリング | 俯瞰的アーキテクチャ、ツール評価 |
| **視点** | 「進捗」を評価 | 「現状の課題」を厳しく指摘 |
| **具体性** | 行番号付きの具体的指摘 | 理想形のコード例を提示 |
| **速度** | 即座に回答 | ファイル読み込みに時間がかかる |

### タスク別の使い分け

| タスク | 使うAI | 理由 |
|--------|--------|------|
| 新機能のアーキテクチャ設計 | **Gemini** | 俯瞰的な設計が得意 |
| 実装コード | **Claude** | 詳細なコーディング |
| コードレビュー | **両方** | 比較して精度向上 |
| バグ修正 | **Claude** | ログ・詳細分析 |
| リファクタリング計画 | **Gemini** | 全体像の把握 |
| リファクタリング実行 | **Claude** | コード変更 |

### Geminiが得意なこと

| 用途 | 例 |
|------|-----|
| アーキテクチャ設計 | Plugin構成、モジュール分割の提案 |
| ベストプラクティス | Bevy公式パターンとの比較 |
| 俯瞰レビュー | 12,000行全体の構造評価 |
| CI/CDツール評価 | スクリプト、自動化の評価 |
| 空間・ベクトル計算の検証 | 回転行列、座標変換、方向計算 |
| 数学的な正しさの確認 | 三角関数、線形代数 |

### Claudeが得意なこと

| 用途 | 例 |
|------|-----|
| unwrap()安全化 | パターンマッチングの提案 |
| リファクタリング差分 | 変更前後の比較 |
| バグ特定 | ログやスタックトレースからの推論 |
| コードの細部 | 命名、型、エラーハンドリング |

### 連携スクリプト

```bash
# 基本：質問スクリプト（回答完了まで待機）
./scripts/ask_gemini.sh "質問" context_file.rs

# コンテキスト同期（Geminiに現在の状態を共有）
./scripts/sync_context.sh generate  # 状態ファイル生成
./scripts/sync_context.sh show      # 内容確認

# デュアルレビュー（両AIに同時依頼）
./scripts/dual_review.sh src/main.rs general

# 監視スクリプト（許可ダイアログ自動処理）
./scripts/watch_gemini.sh 120 --auto-deny

# 直接tmux操作
tmux send-keys -t ai_gemini "質問内容" Enter
tmux attach -t ai_gemini  # 回答確認
```

### 連携パターン

| パターン | 手順 |
|----------|------|
| **設計レビュー** | Gemini→設計案→Claude→実装 |
| **バグ修正** | Claude→修正→Gemini→妥当性確認 |
| **リファクタリング** | Gemini→計画→Claude→実行→Gemini→レビュー |
| **数学計算** | Claude→コード→Gemini→計算検証 |

### ベストプラクティス

1. **大きな設計変更前**: Geminiに俯瞰レビューを依頼
2. **バグが取れない時**: Geminiにセカンドオピニオン
3. **コードレビュー**: 両方に依頼して比較（dual_review.sh）
4. **座標・回転計算**: Geminiで数学的正しさを確認

### 注意点

- `/tmp`はGeminiワークスペース外 → プロジェクト内にファイルを置く
- 抽出コードでも品質十分 → 必要部分だけ渡してトークン節約
- Geminiは読み込みに時間がかかる → 待機スクリプトを使う

## 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| `.claude/architecture.md` | モジュール構成、依存関係、分割ルール |
| `.claude/coding-rules.md` | コーディング規約、命名規則 |
| `.claude/bugs.md` | よくあるバグと対策、チェックリスト |
| `.claude/build.md` | ビルド最適化、プロファイル設定 |
| `.claude/refactoring-tasks.md` | リファクタリングタスク（2026-01-01レビュー） |
| `.specify/memory/input-rules.md` | 入力マトリクス |
| `.specify/memory/modeling-rules.md` | 3Dモデル作成ルール |
| `scripts/ask_gemini.sh` | Gemini質問スクリプト |
| `scripts/watch_gemini.sh` | Gemini出力監視スクリプト |

## 修正済みバグ

BUG-1〜9: 全て修正済み。詳細は `.claude/bugs.md` 参照。

## 現在の状態

- v0.1 MVP: 完了
- フェーズ1-8: 全完了
- テスト: 103件通過
- Clippy警告: 0
- unwrap(): 10箇所のみ

## タスクリスト

### 🔴 リファクタリング（高優先度）

詳細は `.claude/refactoring-tasks.md` 参照

| タスク | 状態 | 効果 |
|--------|------|------|
| block_operations.rs 分割 | ✅ | 1001行→3ファイル |
| ui_setup.rs 分割 | ✅ | 977行→3ファイル |
| targeting.rs 分割 | ✅ | 759行→4ファイル |
| MachineSystemsPlugin 作成 | ✅ | main.rs 300行削減 |
| UIPlugin 作成 | ✅ | UI系システム分離 |
| SavePlugin 作成 | ✅ | セーブ系システム分離 |
| command_ui.rs 分割 | ✅ | 826行→4ファイル |

### バグ修正・クリーンアップ
- [x] unwrap()削減（72箇所→10箇所）
- [x] 未使用コード削除（既に削除済み）

### 自動バグ検出
- [x] Lv1: Fuzzingスクリプト（scripts/fuzz_test.sh）
- [x] Lv2: シナリオテスト（scripts/scenario_test.sh）

### E2E改善（ゲーム内コマンド）
- [x] /testコマンド追加（production, stress）
- [x] /assertコマンド追加（inventory, slot検証）
- [x] /spawn_lineコマンド追加（機械ライン配置）
- [x] /debug_conveyorコマンド追加

### ログ改善
- [x] 構造化ログ形式（EventLogger in logging.rs）
- [x] チャンク生成ログのノイズ削減（DEBUGレベル）

### ログ活用（AI連携）
- [x] ログサマリー生成スクリプト（scripts/summarize_log.sh）
- [x] 異常検出ルール追加（scripts/detect_anomalies.sh）

### コンベア左右逆問題
- [x] L字配置自動テスト（test_conveyor_corner_*）
- [x] 「左」の定義統一（.claude/conveyor-direction.md）

### 将来リスト
- [ ] リプレイシステム: 操作記録・巻き戻し・早送り対応
- [ ] ブループリント: 範囲選択保存・ペースト・エクスポート/インポート
- [ ] 電力システム: 発電機・電線・電力消費・過負荷制御
- [ ] 流体パイプ: ポンプ・パイプ・タンク・流量計算
- [ ] マルチプレイ基盤: WebSocket同期・プレイヤー位置・ブロック操作同期
- [ ] Modding API: Lua/WASM埋め込み・イベントフック
- [ ] ビジュアルプログラミング: ノードグラフで機械の振る舞い定義
