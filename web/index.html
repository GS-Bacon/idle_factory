<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Factory</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a2e;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #eee;
            font-family: sans-serif;
            font-size: 24px;
            text-align: center;
        }
        .progress-container {
            width: 300px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            width: 0%;
            transition: width 0.1s;
        }
        .progress-text {
            font-size: 14px;
            color: #888;
            margin-top: 10px;
        }
        #bevy-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <canvas id="bevy-canvas"></canvas>
    <div id="loading">
        <div>Idle Factory</div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">Preparing...</div>
    </div>
    <div id="controls">
        <b>Controls:</b><br>
        WASD - Move | Mouse - Look<br>
        Left Click - Break | Right Click - Place<br>
        1-4 - Select Item | E - Furnace UI<br>
        Q - Claim Quest Reward
    </div>
    <script type="module">
        import init from './idle_factory.js';

        // === Analytics / Logging ===
        const gameLog = {
            sessionId: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            startTime: Date.now(),
            ua: navigator.userAgent,
            screen: { w: screen.width, h: screen.height, dpr: devicePixelRatio },
            events: [],
            fps: [],
            errors: []
        };

        function logEvent(type, data = {}) {
            gameLog.events.push({ t: Date.now() - gameLog.startTime, type, ...data });
        }

        // Track FPS
        let lastFrameTime = performance.now();
        let frameCount = 0;
        function trackFps() {
            frameCount++;
            const now = performance.now();
            if (now - lastFrameTime >= 5000) { // Every 5 seconds
                const fps = Math.round(frameCount / ((now - lastFrameTime) / 1000));
                gameLog.fps.push({ t: Date.now() - gameLog.startTime, fps });
                frameCount = 0;
                lastFrameTime = now;
            }
            requestAnimationFrame(trackFps);
        }

        // Track errors
        window.addEventListener('error', (e) => {
            gameLog.errors.push({ t: Date.now() - gameLog.startTime, msg: e.message, src: e.filename });
        });

        // Track key presses (game actions only)
        const trackedKeys = new Set(['w','a','s','d','e','q','1','2','3','4','escape']);
        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (trackedKeys.has(key)) {
                logEvent('key', { k: key });
            }
            // ESC to exit pointer lock
            if (key === 'escape' && document.pointerLockElement) {
                document.exitPointerLock();
            }
        });

        // Track mouse clicks and handle pointer lock
        const canvas = document.getElementById('bevy-canvas');
        window.addEventListener('mousedown', (e) => {
            logEvent('click', { btn: e.button });
            // Request pointer lock on canvas click (required for WASM)
            if (e.target === canvas && !document.pointerLockElement) {
                canvas.requestPointerLock();
            }
        });

        // Handle pointer lock change
        document.addEventListener('pointerlockchange', () => {
            if (document.pointerLockElement === canvas) {
                logEvent('pointer_locked');
            } else {
                logEvent('pointer_unlocked');
            }
        });

        // Send logs periodically and on page unload
        function sendLogs() {
            const data = JSON.stringify(gameLog);
            fetch('/game-log', {
                method: 'POST',
                body: data,
                headers: { 'Content-Type': 'application/json' }
            }).catch(() => {});
        }

        setInterval(sendLogs, 30000); // Every 30 seconds
        window.addEventListener('beforeunload', sendLogs);
        window.addEventListener('visibilitychange', () => {
            if (document.hidden) sendLogs();
        });

        async function run() {
            const loadingEl = document.getElementById('loading');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            function setProgress(percent, text) {
                progressBar.style.width = percent + '%';
                progressText.textContent = text;
            }

            try {
                // Fetch WASM with progress
                setProgress(0, 'Downloading WASM...');
                const wasmResponse = await fetch('./idle_factory_bg.wasm');
                const contentLength = wasmResponse.headers.get('Content-Length');
                const total = parseInt(contentLength, 10) || 30000000; // ~30MB fallback

                let loaded = 0;
                const reader = wasmResponse.body.getReader();
                const chunks = [];

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    loaded += value.length;
                    const percent = Math.min(90, Math.round((loaded / total) * 90));
                    setProgress(percent, `Downloading... ${(loaded / 1024 / 1024).toFixed(1)}MB`);
                }

                setProgress(92, 'Compiling WASM...');
                const wasmBytes = new Uint8Array(loaded);
                let offset = 0;
                for (const chunk of chunks) {
                    wasmBytes.set(chunk, offset);
                    offset += chunk.length;
                }

                setProgress(95, 'Initializing...');
                await init(wasmBytes);

                setProgress(100, 'Starting game...');
                loadingEl.style.display = 'none';
                logEvent('game_started');
                trackFps(); // Start FPS tracking
            } catch (e) {
                // winit uses exceptions for control flow - this is normal, not an error
                if (e.toString().includes("Using exceptions for control flow")) {
                    console.log("Game started (winit control flow exception - this is normal)");
                    loadingEl.style.display = 'none';
                    logEvent('game_started');
                    trackFps(); // Start FPS tracking
                    return;
                }

                const errorMsg = e.toString() + '\n\nStack: ' + (e.stack || 'N/A');
                loadingEl.innerHTML =
                    '<div style="color: #ff6b6b; font-size: 20px;">Error loading game</div>' +
                    '<pre style="font-size: 11px; margin-top: 15px; text-align: left; max-width: 90vw; overflow: auto; background: #222; padding: 10px; border-radius: 5px;">' +
                    errorMsg.replace(/</g, '&lt;') + '</pre>' +
                    '<div style="font-size: 12px; margin-top: 15px; color: #888;">WebGL2 required. Try Chrome/Firefox on PC.</div>';
                console.error('WASM Error:', e);
            }
        }

        run();
    </script>
</body>
</html>
