# AI Agent メモリ

このファイルは、AIエージェント（OpenAI Codex、GitHub Copilot、Gemini、GLM等）がこのプロジェクトで作業する際のガイドラインです。

## 禁止事項（MUST NOT）

以下は**絶対に行わないこと**。これらを無視した実装は却下される。

### コード品質
- ❌ `cargo build` を通さずにコード提出
- ❌ 未完成コード（`TODO`, `FIXME`, `unimplemented!()`）
- ❌ 推測での引用（ファイルパス・関数名は確認してから）

### アーキテクチャ
- ❌ `PlayerInventory` を Resource として使用（Component を使う）
- ❌ 個別機械ファイル作成（`machines/generic.rs` を使う）
- ❌ ハードコード機械ロジック（`MachineSpec` + データ駆動を使う）
- ❌ `InteractingFurnace/Crusher/Miner`（`InteractingMachine(Option<Entity>)` を使う）

### 作業スタイル
- ❌ 憶測での修正（ログ/テストで原因特定してから）
- ❌ ドキュメント整理・圧縮作業
- ❌ 仕様だけのセッション2回連続
- ❌ 基盤だけ作って「完了」にする（移行まで完了させる）

## 用語定義（ユビキタス言語）

| 用語 | 意味 | コード上の対応 |
|------|------|---------------|
| **手持ちインベントリ** | プレイヤーが持ち歩くアイテム | `PlayerInventory` (Component) |
| **プラットフォームインベントリ** | 納品プラットフォームに紐づいた倉庫 | `PlatformInventory` (Component) |
| **収納** | コンベア経由でプラットフォームインベントリにアイテムが入ること | `TransferTarget::Delivery` |
| **納品** | クエストのためにアイテムを消費すること | `quest_deliver_button` |

## 基本ルール

| ルール | 詳細 |
|--------|------|
| **ビルド確認** | **必ず `cargo build` を通してから提出** |
| テスト | `cargo test && cargo clippy` |
| コミット | 日本語、短く。pushは指示待ち |
| ゲーム起動 | `./run.sh` |
| バグ修正 | **再現テストなしの修正禁止** |
| アーキテクチャ | `.claude/architecture.md` が権威ソース |

## バグ修正ルール

1. **シナリオテストで再現**（`tests/scenarios/` にTOML作成）
2. テストが失敗することを確認
3. 修正する
4. テストがパスすることを確認

**詳細**: [docs/scenario-test-guide.md](docs/scenario-test-guide.md)

### 「直りました」宣言ルール

**禁止**: コード変更だけで「直りました」と言う

**必須**: 以下のいずれかの証拠を示すこと
1. シナリオテストがパス
2. スクショで修正後の状態を見せる
3. ログ出力で正常動作を確認

**修正ループ検知**:
- 同じファイルを3回編集しても直らない → 止まって報告
- 「直りました」→「直ってない」が2回続いた → 止まって報告

## UI実装ルール

### テキスト作成

| 禁止 | 必須 |
|------|------|
| `TextFont { font_size: X, ..default() }` | `text_font(font, size)` ヘルパー使用 |

**理由**: フォント指定忘れで日本語が文字化けする

### 設定画面への機能追加

`settings_ui.rs` の既存ヘルパーを使用:
```rust
spawn_section_header(panel, font, "セクション名");
spawn_slider(panel, font, "ラベル", SettingType::Xxx, min, max);
spawn_toggle(panel, font, "ラベル", SettingType::Xxx);
```

## メタワーク判定

| やる | やらない |
|------|----------|
| バグ修正、機能追加、テスト追加 | 仕様書詳細化、ドキュメント整理 |
| リファクタ（複雑さ解消） | コード移動だけのリファクタ |
| アーキテクチャ改善 | レビュースキル・パターン集作成 |

**判定**: ゲームが遊べるようになる or バグが減る → やる

## AI出力品質基準

### 絶対禁止
- ツール実行ログの混入
- 未完成コード
- 推測での引用

### 出力構成
1. サマリーテーブル（冒頭に必須）
2. 詳細セクション
3. コード例
4. 根拠（ファイル:行番号で引用）

## バイブコーディング限界実験

このプロジェクトは「非エンジニアがAIだけで大規模ゲームを作れるか」の実験。

### 観測すべき破綻パターン
1. **コンテキスト限界** - AIが以前の決定を忘れる
2. **メタワーク暴走** - ゲームが進まずドキュメントだけ増える
3. **修正ループ** - AIがAIの書いたコードを直す無限ループ
4. **設計の不整合** - モジュール間で噛み合わない

### 暴走検知
```
AIが1時間作業したら → ゲームを起動して変化を見せる
変化がない or 説明が長い → 暴走の兆候
```

## 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| **`.claude/architecture.md`** | **将来アーキテクチャ設計（権威ソース）** |
| `.claude/implementation-plan.md` | タスク一覧 |
| `docs/scenario-test-guide.md` | シナリオテスト詳細 |

## 現在の状態

| 項目 | 値 |
|------|-----|
| バージョン | **0.3.184** |
| コード行数 | **29,253行** |
| テスト | **613件** 通過 |
| 移行状態 | **✅ 新アーキ完全移行済み** |

## 特殊操作

### Windowsへビルド送信

**トリガー**: 「windowsに送信」「windowsに送って」等

```bash
# 1. Windowsパッケージをビルド（zip作成）
./scripts/build-packages.sh --windows-only

# 2. Tailscale経由でzipを送信
tailscale file cp dist/idle_factory_*_windows.zip baconrogx13: || \
tailscale file cp dist/idle_factory_*_windows.zip smz-mousebook:
```

**禁止**: exeだけ送る、GitHub Releasesにアップロード、scp/rsync

### 作業ログ保存

「ログを保存」と言われたら `WORK_LOG.md` に追記。

```markdown
## YYYY-MM-DD: タイトル

### 概要
1-2行で何をしたか

### 決定事項
- 箇条書きまたはテーブル

### 学び
- 重要な決定とその理由
```

## 検証の分担

| 担当 | 内容 |
|------|------|
| AI | ビルド、テスト、E2E、スクリーンショット確認 |
| 人間 | ゲームプレイ体験（面白さ、直感性） |

## 互換性ポリシー

- **既存プレイヤーはいない** → セーブデータ移行は不要
- 破壊的変更OK、古いセーブ切り捨てOK
