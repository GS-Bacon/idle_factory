name: Cache Cleanup

on:
  # 毎週月曜 0:00 UTC に実行
  schedule:
    - cron: '0 0 * * 1'
  # 手動実行も可能
  workflow_dispatch:

jobs:
  cleanup:
    name: Cleanup old caches
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Cleanup old caches
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            console.log(`Fetching caches for ${owner}/${repo}...`);

            // 全キャッシュを取得
            const caches = await github.rest.actions.getActionsCacheList({
              owner,
              repo,
              per_page: 100
            });

            console.log(`Found ${caches.data.total_count} caches`);

            // 7日以上古いキャッシュを削除
            const now = new Date();
            const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);

            let deleted = 0;
            let kept = 0;

            for (const cache of caches.data.actions_caches) {
              const lastAccessed = new Date(cache.last_accessed_at);

              if (lastAccessed < sevenDaysAgo) {
                console.log(`Deleting: ${cache.key} (last used: ${cache.last_accessed_at})`);
                await github.rest.actions.deleteActionsCacheById({
                  owner,
                  repo,
                  cache_id: cache.id
                });
                deleted++;
              } else {
                console.log(`Keeping: ${cache.key} (last used: ${cache.last_accessed_at})`);
                kept++;
              }
            }

            console.log(`\nSummary: Deleted ${deleted} caches, kept ${kept} caches`);
