# 残りタスク実装計画 (2026-01-07)

## 現状分析

| 項目 | 状態 |
|------|------|
| GameSettings | ✅ 定義済み、load/save実装済み |
| SettingsPlugin | ✅ 定義済み、**未登録** |
| 設定の適用 | ❌ システムが設定値を参照していない |
| 設定画面UI | ❌ 未実装 |
| ポーズメニュー | ❌ ESCで開くが表示なし |
| config.toml | ❌ 存在するが読み込まれていない |

---

## Phase D: 設定システム完成

### D.1 設定基盤の有効化（小・1時間）

| # | タスク | 詳細 |
|---|--------|------|
| D.1-1 | SettingsPlugin登録 | `plugins/game.rs`に追加 |
| D.1-2 | 設定値をシステムに適用 | player.rs, chunk.rs等で`Res<GameSettings>`参照 |
| D.1-3 | config.toml読み込み削除 | 不要（settings.jsonに統一） |

**変更ファイル**: `plugins/game.rs`, `systems/player.rs`, `world/mod.rs`

### D.2 ポーズメニューUI（中・2時間）

| # | タスク | 詳細 |
|---|--------|------|
| D.2-1 | PauseMenuPanel作成 | ESCで表示されるメニュー |
| D.2-2 | ボタン: 再開/設定/終了 | 基本メニュー構成 |
| D.2-3 | 画面暗転オーバーレイ | インベントリと共通化 |

**レイアウト**:
```
┌─────────────────────┐
│                     │
│      一時停止        │
│                     │
│     [ 再開 ]        │
│     [ 設定 ]        │
│     [ 終了 ]        │
│                     │
└─────────────────────┘
```

**変更ファイル**: `setup/ui/pause_menu.rs`（新規）, `systems/ui_navigation.rs`

### D.3 設定画面UI（中・3時間）

| # | タスク | 詳細 |
|---|--------|------|
| D.3-1 | スライダーWidget | 汎用コンポーネント |
| D.3-2 | トグルWidget | ON/OFFスイッチ |
| D.3-3 | タブパネル | グラフィック/操作/音声 |
| D.3-4 | 設定変更イベント送信 | SettingsChangedEvent |
| D.3-5 | 戻るボタン | ポーズメニューに戻る |

**レイアウト**:
```
┌─────────────────────────────────┐
│  設定                      [×]  │
├─────────────────────────────────┤
│ [グラフィック] [操作] [音声]     │
├─────────────────────────────────┤
│ 描画距離    [━━━━●━━] 3         │
│ 視野角      [━━━━━●━] 70°       │
│ VSync       [✓]                 │
│ フルスクリーン [ ]              │
├─────────────────────────────────┤
│            [デフォルト] [適用]   │
└─────────────────────────────────┘
```

**変更ファイル**: `ui/widgets.rs`, `setup/ui/settings_ui.rs`（新規）

### D.4 即時反映（小・1時間）

| # | タスク | 詳細 |
|---|--------|------|
| D.4-1 | view_distance変更 | チャンク再読み込み |
| D.4-2 | fov変更 | カメラProjection更新 |
| D.4-3 | mouse_sensitivity変更 | 即座に反映 |
| D.4-4 | vsync変更 | Window設定更新 |

**変更ファイル**: `systems/settings_apply.rs`（新規）

---

## Phase E: ボクセル最適化（オプション）

### E.1 差分メッシュ更新（中・2時間）

現状: ブロック変更時に隣接4チャンク全体を再生成
改善: 境界面のみ更新

| # | タスク | 詳細 |
|---|--------|------|
| E.1-1 | 境界面検出 | 変更ブロックが境界かどうか判定 |
| E.1-2 | 部分メッシュ更新 | 境界チャンクの境界面のみ再生成 |

**変更ファイル**: `world/mod.rs`, `systems/chunk.rs`

### E.2 LOD実装（大・4時間）

現状: 全チャンク同一詳細度
改善: 距離に応じた詳細度切り替え

| # | タスク | 詳細 |
|---|--------|------|
| E.2-1 | LODレベル定義 | 0: フル, 1: 2x2統合, 2: 4x4統合 |
| E.2-2 | 距離に応じたLOD選択 | 2チャンク以上でLOD1 |
| E.2-3 | LOD切り替え時のメッシュ再生成 | |

**変更ファイル**: `world/mod.rs`, `world/lod.rs`（新規）

### E.3 パレット方式（中・2時間）

現状: `Vec<Option<BlockType>>` - 各ブロックにEnum直接
改善: `Vec<u8>` + `Vec<BlockType>` パレット参照

| # | タスク | 詳細 |
|---|--------|------|
| E.3-1 | ChunkDataにpalette追加 | |
| E.3-2 | get_block/set_blockをパレット経由に | |
| E.3-3 | パレット圧縮（未使用エントリ削除） | |

**変更ファイル**: `world/mod.rs`

---

## 実装順序

```
Phase D（必須）
D.1 設定基盤 ─→ D.2 ポーズメニュー ─→ D.3 設定画面 ─→ D.4 即時反映
    (1h)              (2h)                (3h)            (1h)
                                                           ↓
                                                      設定システム完成
                                                           ↓
Phase E（オプション・パフォーマンス向上時）
E.1 差分メッシュ ─→ E.2 LOD ─→ E.3 パレット
      (2h)            (4h)        (2h)
```

---

## 優先順位

| 順位 | タスク | 理由 |
|------|--------|------|
| **1** | D.1 設定基盤有効化 | 即効果、依存なし |
| **2** | D.2 ポーズメニュー | ESCが何も表示しないのは不自然 |
| **3** | D.3 設定画面 | ユーザビリティ向上 |
| **4** | D.4 即時反映 | 設定の意味がある |
| 5 | E.1 差分メッシュ | パフォーマンス |
| 6 | E.2 LOD | パフォーマンス |
| 7 | E.3 パレット | メモリ最適化 |

---

## 見積もり合計

| Phase | 工数 |
|-------|------|
| D（設定システム） | 7時間 |
| E（ボクセル最適化） | 8時間 |
| **合計** | **15時間** |

---

## 次のアクション

D.1から開始：
1. `plugins/game.rs`に`SettingsPlugin`追加
2. `systems/player.rs`で`mouse_sensitivity`を`GameSettings`から取得
3. `world/mod.rs`で`view_distance`を`GameSettings`から取得
