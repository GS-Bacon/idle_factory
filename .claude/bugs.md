# よくあるバグと対策

**重要**: 新機能実装時、このセクションのパターンに該当する場合は対応するテストも追加すること。

## バグ修正手順

**重要**: バグ修正タスクを受けたら、まずログを解析してから修正に着手する。
**絶対禁止**: 憶測での修正。「多分これが原因」で修正してはいけない。

### 1. ログ取得

**ネイティブ版**:
```bash
./run.sh                    # ゲーム起動
./show-logs.sh              # 最新ログ
./show-logs.sh errors       # エラーのみ
./show-logs.sh events       # BLOCK, MACHINE, QUEST
```

**WASM版**:
```bash
node capture-wasm-logs.js   # 30秒キャプチャ
./show-logs.sh wasm
```

### 2. 画面検証

```bash
./verify-native.sh          # スクリーンショット撮影
# screenshots/verify/native_*.png を確認
```

## バグパターン一覧

### 1. 地面が透ける（黒い穴）
- **原因**: メッシュのワインディング順序が間違っている
- **検出**: `cargo test test_mesh_winding_order`
- **対策**: 面定義の頂点順序を修正

### 2. 機械設置時に地面が透ける
- **原因**: 機械設置時に`set_block()`で偽のブロックを登録
- **対策**: 機械はエンティティなので`set_block()`を呼ばない

### 3. エンティティ破壊時に子エンティティが残る
- **原因**: 親削除時に子を削除していない
- **対策**: 破壊時に関連エンティティもdespawn

### 4. チャンク境界でブロックが消える
- **原因**: 隣接チャンク情報なしでメッシュ生成
- **対策**: `generate_mesh_with_neighbors`で隣接情報を渡す

### 5. ブロック操作時のフリーズ
- **原因**: チャンク再生成パターンが不統一
- **対策**: 同じ再生成パターンを使用

### 6. レイキャスト判定漏れ
- **原因**: 新機械追加時にレイキャスト判定を追加し忘れ
- **対策**: 新機械追加時は必ず判定を更新

### 7. 機械破壊時にアイテム消失
- **原因**: 破壊時にスロット内容をインベントリに返却していない
- **対策**: despawn前に全スロットを返却

### 8. モード別UI表示制御漏れ
- **原因**: CreativeModeチェックなしで常に表示
- **対策**: マーカーコンポーネント追加、モードチェック

### 9. UI表示中のポインターロック
- **原因**: canvasクリック時にUI状態をチェックせず
- **対策**: `isGameUIOpen()`をチェック

### 10. UI表示中に操作が効く
- **原因**: システムがInventoryOpenをチェックしていない
- **対策**: InputState.allows_*()でチェック

### 11. プレビューと実際の動作が異なる
- **原因**: プレビューと実処理で異なるロジック
- **対策**: 同じ関数を呼び出す

### 12. ESCでUI閉じた後にポインターロック解除
- **原因**: ブラウザはESCでポインターロック解除する
- **対策**: JS側で自動再ロック（50ms後）

### 13. チャンク処理で長時間フリーズ
- **原因**: 複数チャンクが同時に完了
- **対策**: 1フレームの処理数を制限（MAX_CHUNKS_PER_FRAME=2）

### 14. チャンク再読み込みで変更リセット
- **原因**: チャンクアンロード時にデータ削除
- **対策**: modified_blocksで変更を永続化

## 実装時チェックリスト

- [ ] メッシュ変更 → ワインディング順序テスト
- [ ] 機械追加 → レイキャスト判定、破壊時クリーンアップ、アイテム返却
- [ ] 子エンティティ持ち → 破壊時に子もdespawn
- [ ] チャンク操作 → 境界テスト
- [ ] モード専用UI → モードチェック、マーカー追加
- [ ] UI追加 → `set_ui_open_state`呼び出し
- [ ] ESCで閉じるUI → JS側で自動再ロック確認
- [ ] 毎フレーム処理 → バッチ処理に制限

## 未修正バグ（インベントリUI関連）

### BUG-UI-1: スプライト画像が小さくて見づらい
- **状態**: 未修正
- **詳細**: アイテムスロット内のスプライト画像サイズが小さすぎる

### BUG-UI-2: クリエイティブカタログのアイコンがスプライト未適用
- **状態**: 未修正
- **詳細**: クリエイティブカタログ（上部）のアイテムアイコンにスプライトが適用されていない

### BUG-UI-3: アイテムスロットにアイテムの色が表示されている
- **状態**: 未修正
- **詳細**: スロット背景にアイテムの色が表示され、見た目がおかしい

### BUG-UI-4: ドラッグ中にアイテムが表示されない
- **状態**: 未修正
- **詳細**: ドラッグ&ドロップ中にアイテムが見えない

### BUG-UI-5: ドラッグ&ドロップ仕様変更
- **状態**: 仕様確定
- **参考**: [Mouse Tweaks Mod](https://www.curseforge.com/minecraft/mc-mods/mouse-tweaks)
- **詳細**: 以下の仕様に変更

#### 採用する操作仕様

| 操作 | 動作 |
|------|------|
| 左クリック長押し+ドラッグ | アイテムを掴んで移動 |
| Shift+左クリック | クイック移動（別インベントリへ転送）※既存維持 |
| Shift+左クリック+ドラッグ | ドラッグした同種アイテムを全てクイック移動 |
| 右クリック+ドラッグ | スタックを均等配分（通過スロットに1個ずつ配置） |
| スクロールホイール | アイテムを1個ずつ移動（上:引き出す、下:押し出す） |

#### Mouse Tweaksからの取り込み機能

1. **LMB Tweak（左クリック）**
   - アイテム持ち状態でドラッグ: 同種アイテムを集める
   - Shift+ドラッグ: 通過した同種アイテムをshift-click

2. **RMB Tweak（右クリック）**
   - 複数回通過で複数個配置可能（標準と異なる点）

3. **Wheel Tweak（スクロール）**
   - スクロールで1個ずつアイテム移動
   - 上下方向で移動先切り替え

## テスト追加ルール

| 変更タイプ | 必須テスト |
|-----------|-----------|
| 新機能 | 正常系 + エッジケース |
| バグ修正 | 再発防止テスト |
| リファクタリング | 既存テストでOK |
