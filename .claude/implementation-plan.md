# 実装計画

> **設計詳細**: `.claude/architecture-future.md`
> **ロードマップ**: `.specify/roadmap.md`（概要）

## 現状サマリー (2026-01-09)

| 項目 | 値 |
|------|-----|
| バージョン | **0.3.136** |
| コード行数 | **29,253行** |
| テスト | **613件** 通過 |
| Clippy警告 | **0件** |
| 現在のフェーズ | **M2→M3: 技術的負債解消** |

---

## マイルストーン一覧

| MS | 名前 | 状態 | 概要 |
|----|------|------|------|
| M0 | 基盤整備 | ✅ 完了 | Component化、動的ID、イベント |
| M1 | Data Mod | ✅ 完了 | TOML読み込み |
| M2 | Core Mod基盤 | ✅ 完了 | WASM Mod対応 |
| - | **技術的負債解消** | **← 今ここ** | UI.1, N.x, API Wiki |
| M3 | 電力システム | ❌ 未着手 | 発電機、電線、消費 |
| M4 | 液体・信号 | ❌ | パイプ、論理回路 |
| M4.5 | ツール・ビジュアル | ❌ | レシピエディタ、見た目強化 |
| M5 | ゲーム完成 | ❌ | 機械50種、マップ、ブループリント |
| M6 | マルチプレイ | ❌ | P2P、同期、権限 |

---

## M0: 基盤整備 ✅ 完了

| タスク | 確認方法 |
|--------|----------|
| LocalPlayer Entity化 | 47箇所で使用 |
| PlayerInventory Component化 | `Res<PlayerInventory>` 0件 |
| BlockType→ItemId移行 | BlockType 0箇所 |
| イベントシステム | GuardedEventWriter 16箇所 |
| パニック防止 (P.0-P.4) | フォールバック実装済み |
| 固定Tick導入 | FixedUpdate(20Hz) |

---

## M1: Data Mod ✅ 完了

| タスク | 確認方法 |
|--------|----------|
| TOML読み込み | 起動時ロード実装済み |
| アイテム/機械/レシピ追加 | コード変更なしで可能 |

---

## M2: Core Mod基盤 ✅ 完了 (2026-01-09)

| タスク | 状態 |
|--------|------|
| W.1 Wasmtime統合 | ✅ |
| W.2 ホスト関数API | ✅ |
| W.3 サンプルMod | ✅ |
| W.4 依存解決 | ✅ |
| W.5 ホットリロード | ✅ |
| W.6 タグシステム | ✅ |
| W.7 特殊機械Mod化 | ✅ |

**実装ファイル**: `src/modding/wasm/` - 8ファイル

---

## M2→M3: 技術的負債解消 ← 今ここ

### UI.1: UI Visibility システム改善 ✅ 完了

`UIVisibilityTarget` コンポーネントで全UIを統一管理。
詳細: `src/ui/visibility.rs`, `src/systems/ui_visibility.rs`

---

### API Wiki: ドキュメント自動生成 ✅ 完了

| タスク | 内容 | 状態 |
|--------|------|------|
| AW.1 | ドキュメントコメント整備 | ✅ |
| AW.2 | GitHub Actions設定 | ✅ |
| AW.3 | Wiki自動更新 | ✅ |

**実装ファイル**:
- `scripts/generate-wiki.py` - ドキュメント抽出・検証・Wiki生成
- `.github/workflows/wiki.yml` - GitHub Actions
- `wiki/` - 生成されたWikiページ

**トリガー**: `src/modding/**` 変更時 → Wiki自動更新

**検証機能**: ドキュメント不足のAPIをエラーとして検出

---

### N: リソースネットワーク設計 ❌ 未着手

**⚠️ ユーザーと相談しながら進めること**

**目標**: 電力・液体・信号を統一的に扱える汎用基盤

| タスク | 内容 | 状態 |
|--------|------|------|
| N.1 | リソース種別の抽象定義 | ❌ |
| N.2 | ネットワーク接続の仕組み | ❌ |
| N.3 | ノード種別（Producer/Consumer/Storage/Conduit） | ❌ |
| N.4 | 計算方式（供給/需要/優先度） | ❌ |
| N.5 | Mod拡張ポイント | ❌ |

**設計案**:
```rust
struct ResourceType {
    name: String,
    unit: String,
    decay: bool,
    max_transfer: f32,
    // M4で追加: is_signal, propagation_delay
}
```

| 特性 | 電力・液体 | 信号 |
|------|-----------|------|
| 値の型 | 数値 | ON/OFF or 0-15 |
| 分岐時 | 分割される | コピーされる |
| 消費 | 使うと減る | 減らない |

---

## M3: 電力システム

| タスク | 内容 |
|--------|------|
| P.1 | 電力グリッド計算 |
| P.2 | 発電機（水車、石炭発電） |
| P.3 | 電線ブロック |
| P.4 | 電力消費機械 |
| P.5 | 電力UI |

---

## M4: 液体・信号

| タスク | 内容 |
|--------|------|
| F.1 | 液体スロット・パイプ |
| F.2 | ポンプ・タンク |
| S.1 | 信号ワイヤー |
| S.2 | センサー |
| S.3 | 論理ゲート |

---

## M4.5: 調整ツール & ビジュアル強化

### E: レシピエディタ（WebUI）

**目標**: 非エンジニアがブラウザからレシピ調整できる

| タスク | 内容 | 状態 |
|--------|------|------|
| E.1 | WebSocket APIにTOML読み書き追加 | ❌ |
| E.2 | 簡易HTML+JSエディタUI | ❌ |
| E.3 | バリデーション（不正レシピ検出） | ❌ |
| E.4 | ゲーム再起動なしリロード（stretch） | ❌ |

### V: ビジュアル強化

**目標**: 見た目のインパクト向上

| タスク | 内容 | 状態 |
|--------|------|------|
| V.1 | ライティング改善 | ❌ |
| V.2 | ポストプロセス（ブルーム等） | ❌ |
| V.3 | 機械アニメーション | ❌ |
| V.4 | パーティクル | ❌ |
| V.5 | サウンド | ❌ |

---

## M5: ゲーム完成

- 機械50種類以上
- レシピ100種類以上
- マップ機能
- ブループリント

---

## M6: マルチプレイ

- P2P接続
- 状態同期
- 権限管理

---

## 付録

### 新コンテンツ追加フロー

**現在（Data Mod）**:
```
1. mods/base/items.toml に追加（3行）
2. mods/base/machines.toml に追加（10行）
3. mods/base/recipes.toml に追加（3行）
4. assets/models/ に3Dモデル配置
5. 完了（Rustコード変更なし）
```

**M2完了後（Core Mod）**:
```
1. mods/my_mod/Cargo.toml 作成
2. mods/my_mod/src/lib.rs に新ロジック
3. cargo build --target wasm32-unknown-unknown
4. mods/my_mod/mod.toml で依存宣言
5. 完了（本体コード変更なし）
```

### M5完了時: リポジトリ名変更

**ゲーム名: RisoFactory**（理想ファクトリー）

| タスク | 内容 |
|--------|------|
| R.1 | GitHubリポジトリ名を `riso-factory` に変更 |
| R.2 | `Cargo.toml` の `name` を `riso_factory` に変更 |
| R.3 | コード内の `idle_factory` 参照を更新 |
| R.4 | ウィンドウタイトルを「RisoFactory」に変更 |
| R.5 | README、ドキュメント更新 |

**名前の由来**:
- 日本語: 理想（りそう）+ Factory
- イタリア語: Riso = 米 & 笑い
- 「笑いの工場」というダブルミーニング

---

*最終更新: 2026-01-09*
