# 統合実装計画 (2026-01-04 更新)

## 現状サマリー

| 項目 | 値 |
|------|-----|
| コード行数 | **20,803行** (目標19,500行以下) |
| テスト | **280件** 通過 (lib:81, bin:38, e2e:146, fuzz:11, proptest:8, ssim:3) |
| unwrap() | **17箇所** (全てテストコード内) |
| Clippy警告 | **0件** |
| カバレッジ | **8.54%** (全体)、ロジック部分70%+ |

---

## 優先順位（2026-01-04 更新）

| 順位 | カテゴリ | 理由 |
|------|----------|------|
| **1** | v0.2完成 | ゲームとして遊べる状態に |
| **2** | アーキテクチャ再設計 | 将来機能の土台（-1,300行） |
| **3** | 機能拡張 | v0.3以降の新機能 |

---

## Phase A: v0.2完成（短期）

### A.1 UIテーマ刷新 (旧Phase 8)

| タスク | 詳細 | 状態 |
|--------|------|------|
| テーマ定数追加 | `ui/mod.rs`にスロット/クエスト色定義 | [ ] |
| スロットBorderRadius追加 | インベントリ・ホットバー | [ ] |
| ホバー/選択スタイル | Interaction監視で色変更 | [ ] |
| クエストパネル更新 | BorderRadius + テーマ色 | [ ] |
| 機械UI統一 | 共通スタイル関数抽出 | [ ] |

**テーマ値**: 48px, 角丸6px, `#ff8800`(オレンジ), `#ffcc00`(黄色選択)

### A.2 バイオーム表示UI (旧Phase 14)

| タスク | 詳細 | 状態 |
|--------|------|------|
| 足元バイオームHUD | 画面左上に表示 | [ ] |
| F3デバッグ表示 | バイオーム名・確率表示 | [ ] |
| 位置変化時のみ更新 | Local<IVec3>で最適化 | [ ] |

### A.3 チュートリアル (旧Phase 9)

| タスク | 詳細 | 状態 |
|--------|------|------|
| TutorialProgress実装 | 進捗管理リソース | [ ] |
| 8ステップ定義 | 移動→採掘→インベントリ→機械設置 | [ ] |
| チュートリアルUI | 画面上部中央に目標表示 | [ ] |
| 完了後メインクエスト開始 | 自動遷移 | [ ] |

---

## Phase B: アーキテクチャ再設計（中期）

**参照**: [architecture-redesign.md](architecture-redesign.md)

### B.1 準備（破壊的変更なし） ⏱️2-3時間

| タスク | 詳細 | 削減行数 |
|--------|------|----------|
| core/モジュール作成 | 純粋ロジック（Bevy非依存） | +100行 |
| 機能コンポーネント定義 | ItemAcceptor, ItemEjector, Crafter | +50行 |
| MachineDescriptor定義 | 機械メタデータ | +50行 |
| ui/widgets.rs作成 | spawn_slot, spawn_button | +100行 |

### B.2 物流インフラ分離 ⏱️1-2時間

| タスク | 詳細 | 削減行数 |
|--------|------|----------|
| logistics/conveyor.rs | systems/conveyor.rsから移動 | 0（移動） |
| コンベア専用最適化 | 必要に応じて | - |

### B.3 機械統合 ⏱️3-4時間

| タスク | 詳細 | 削減行数 |
|--------|------|----------|
| machines/作成 | miner, furnace, crusher統合 | -200行 |
| 共通システム抽出 | accept_items, crafting | -150行 |
| components/machines.rs削除 | machines/components.rsに統合 | -100行 |

### B.4 UI統合 ⏱️3-4時間

| タスク | 詳細 | 削減行数 |
|--------|------|----------|
| ui/machine.rs | 機械UI自動生成 | -300行 |
| ui/inventory.rs | inventory_ui.rsから移動 | -100行 |
| 3箇所のUI統合 | setup/ui/, systems/inventory_ui, ui/ | -200行 |

### B.5 セーブ統合 ⏱️1-2時間

| タスク | 詳細 | 削減行数 |
|--------|------|----------|
| save/作成 | save.rs + save_systems.rs統合 | -100行 |
| 変換マクロ化 | BlockTypeSave等 | -50行 |

### B.6 最適化 ⏱️1時間

| タスク | 詳細 | 効果 |
|--------|------|------|
| main.rs分割 | GamePlugin化 | 可読性向上 |
| debug/ cfg分離 | `#[cfg(debug_assertions)]` | リリース軽量化 |
| updater/ feature gate | `feature = "updater"` | 必要時のみ |

**合計削減**: -1,300行（20,803行 → 19,500行）

---

## Phase C: 機能拡張（長期）

### C.1 ゲームデータ外部化 (旧Phase 11)

| タスク | 詳細 | トリガー |
|--------|------|----------|
| recipes.json | レシピ定義外出し | バランス調整増加時 |
| quests.json | クエスト定義外出し | 同上 |
| machines.json | 機械パラメータ外出し | 同上 |

### C.2 BlockType階層化 (旧Phase 13)

| タスク | 詳細 | トリガー |
|--------|------|----------|
| 新Enum定義 | TerrainBlock, OreBlock等 | B.3完了後 |
| 相互変換実装 | as_game_item() | 同上 |
| ロジック移行 | 段階的にGameItemへ | 新アイテム追加時 |

### C.3 v0.3新機能

| 機能 | 詳細 | 依存 |
|------|------|------|
| 電力システム | 発電機・導管・消費 | B.1のNetwork基盤 |
| 流体パイプ | ポンプ・パイプ・タンク | 同上 |
| マルチプレイ | WebSocket同期 | アーキテクチャ安定後 |
| Modding API | Lua/WASM | レジストリパターン |

---

## 完了済みタスク

<details>
<summary>クリックで展開</summary>

### リファクタリング
- [x] block_operations.rs 分割 (1001行→3ファイル)
- [x] ui_setup.rs 分割 (977行→3ファイル)
- [x] targeting.rs 分割 (759行→4ファイル)
- [x] command_ui.rs 分割 (826行→4ファイル)
- [x] MachineSystemsPlugin 作成
- [x] UIPlugin 作成
- [x] SavePlugin 作成

### パフォーマンス改善 (旧Phase 1)
- [x] ハイライトメッシュキャッシュ化
- [x] O(N²)コンベア転送→HashMap化
- [x] Vec::contains()→HashSet化
- [x] クエストデータ変換キャッシュ

### セキュリティ・エラー処理 (旧Phase 2)
- [x] unwrap()削減 (72箇所→17箇所)
- [x] 配列インデックス範囲チェック
- [x] コマンドパス走査防止
- [x] NaN/Infinity処理

### v0.2機能 (旧Phase 3)
- [x] GlobalInventory基盤
- [x] 機械設置/撤去
- [x] 8列グリッドレイアウト
- [x] ページネーション
- [x] カテゴリタブ・検索機能
- [x] 納品ボタン
- [x] 機械入出力システム
- [x] バイオーム採掘システム

### テスト強化 (旧Phase 4)
- [x] カバレッジ計測 (8.54%全体、ロジック70%+)
- [x] コンベア統合テスト
- [x] セーブ/ロード往復テスト
- [x] UIインタラクションテスト
- [x] SSIM比較テスト
- [x] ファジング基盤

### プラットフォーム再設計 (旧Phase 10)
- [x] PlatformBlock追加
- [x] DeliveryPlatform.delivered削除
- [x] GlobalInventory経由に変更

</details>

---

## 実行順序マトリクス

```
【v0.2完成】
A.1 UIテーマ ──┐
A.2 バイオームUI ├─→ v0.2リリース
A.3 チュートリアル ┘

【アーキテクチャ再設計】（v0.2完成後）
B.1 準備 ─→ B.2 物流分離 ─→ B.3 機械統合 ─→ B.4 UI統合 ─→ B.5 セーブ ─→ B.6 最適化
                                    │
                                    ↓
【機能拡張】（B.3完了後）         C.2 BlockType階層化
C.1 データ外部化                    │
C.3 v0.3新機能 ←────────────────────┘
```

---

## 合見積サマリー（2026-01-04）

| 観点 | Claude | Gemini | 採用 |
|------|--------|--------|------|
| 機械設計 | Machineトレイト | ECSコンポジション | **Gemini** |
| コンベア | 機械として統合 | 物流インフラ分離 | **Gemini** |
| UI | 共通化 | Entity Observers | **両方** |
| 移行 | 3Phase | 垂直分割 | **Gemini** |

**結論**: ECSの特性を活かし、`tick()`メソッドに依存せず、機能コンポーネント（ItemAcceptor, Crafter等）で構成

---

## 次のアクション

1. **Phase A.1**: UIテーマ刷新（すぐ開始可能）
2. **Phase A.2**: バイオーム表示UI
3. **Phase A.3**: チュートリアル
4. **v0.2リリース**
5. **Phase B.1**: アーキテクチャ準備（core/作成）
