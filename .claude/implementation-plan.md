# 実装計画 (2026-01-02)

## 現状サマリー
- コード: **10,957行**（目標12,500行以下は達成済み）
- テスト: **113件通過**
- unwrap(): **17箇所**（save.rs:5, main.rs:5, game_spec.rs:7）

## 優先順位（ゲームを遊べるようにする観点）

| 順位 | カテゴリ | 理由 |
|------|----------|------|
| **1** | パフォーマンス改善 | FPS低下は体験を直接損なう |
| **2** | セキュリティ・エラー処理 | クラッシュ防止 |
| **3** | テスト強化 | バグ早期発見、回帰防止 |
| **4** | コードダイエット | 将来の機能追加を楽に |

## Phase 1: パフォーマンス改善（並行可能）

| タスク | ファイル | 影響度 | 状態 |
|--------|----------|--------|------|
| ハイライトメッシュキャッシュ化 | highlight.rs:92-141 | 高 | [ ] |
| O(N²)コンベア転送→HashMap化 | conveyor.rs:300-359 | 高 | [ ] |
| Vec::contains()→HashSet化 | chunk.rs, conveyor.rs | 中 | [ ] |
| 不要なclone削除 | conveyor.rs:220,265 | 低 | [ ] |
| クエストデータ変換キャッシュ | quest.rs:20-46 | 低 | [ ] |

## Phase 2: セキュリティ・エラー処理（並行可能）

| タスク | ファイル | 状態 |
|--------|----------|------|
| main.rsのunwrap削除 | main.rs:239-295 | [ ] |
| save.rsのunwrap削除 | save.rs | [ ] |
| game_spec.rsのunwrap削除 | game_spec.rs | [ ] |
| 配列インデックス範囲チェック | world/mod.rs:71-73 | [ ] |
| 座標キーの範囲チェック | save.rs:184-194 | [ ] |
| コマンドパス走査防止 | command系 | [ ] |
| コマンドパース検証強化 | /tp, /give等 | [ ] |
| NaN/Infinity処理 | f32::is_finite()追加 | [ ] |

## Phase 3: テスト強化

| タスク | 詳細 | 状態 |
|--------|------|------|
| カバレッジ計測 | `cargo tarpaulin`で現状把握 | [ ] |
| コンベア統合テスト | 複数連結・分岐・合流 | [ ] |
| セーブ/ロード往復テスト | 保存→読込→比較 | [ ] |
| UIインタラクションテスト | ボタン押下→状態変化 | [ ] |
| インベントリUIテスト | 650行あるがテストなし | [ ] |
| システム間連携テスト | Miner→Conveyor→Furnace→Delivery | [ ] |
| エッジケーステスト | 満杯時、空時、境界値 | [ ] |
| 負荷テスト | 大量アイテム・大量機械 | [ ] |

## Phase 4: コードダイエット（順序依存）

| タスク | 削減量 | 依存 | 状態 |
|--------|--------|------|------|
| machine_interact統合 | -190行 | なし | [ ] |
| machine_output統合 | -110行 | ↑完了後 | [ ] |
| machine_ui_input統合 | -145行 | ↑完了後 | [ ] |
| Color定数化 | -80行 | なし | [ ] |
| raycast共通化 | -45行 | なし | [ ] |

## 並行実行マトリクス

```
Phase 1 の全タスク → 並行OK
Phase 2 の全タスク → 並行OK
Phase 1 と Phase 2 → 一部並行OK（ファイル重複なければ）
Phase 4 のmachine系 → 順序必須（同じファイル群を変更）
```

## 次のアクション

1. Phase 1 のパフォーマンス改善から開始
2. highlight.rs と conveyor.rs を並行で改善
3. 完了後 Phase 2 へ
