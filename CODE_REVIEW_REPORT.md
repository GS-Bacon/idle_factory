# コードレビュー比較レポート

**日付**: 2026-01-01
**レビュー対象**: Idle Factory v0.1
**レビュアー**: Claude Opus 4.5 / Gemini 2.0

---

## 概要統計

| 項目 | 値 |
|------|-----|
| 総コード行数 | 約10,000行 |
| テスト件数 | 103件 (全通過) |
| Clippy警告 | 0件 |
| unwrap()使用 | 10箇所 (main.rs: 5, save.rs: 5) |
| 最大ファイル | command_ui.rs (826行) |

---

## 評価比較

| 観点 | Claude | Gemini | 差異 |
|------|--------|--------|------|
| **アーキテクチャ** | 8/10 | 7/10 | Claude +1 |
| **コード品質** | 8/10 | 7/10 | Claude +1 |
| **Bevyパターン** | 8/10 | 8/10 | 同点 |
| **安全性** | 9/10 | - | Gemini未評価 |
| **拡張性** | 7/10 | 7/10 | 同点 |
| **ツール・CI** | - | 10/10 | Claude未評価 |
| **総合** | **8.0/10** | **7.5/10** | Claude +0.5 |

---

## Claude Opus 4.5 レビュー

### 良い点

1. **プラグイン分割の進捗**
   - MachineSystemsPlugin, UIPlugin, SavePlugin が適切に分離
   - 機械関連の40+システムがmain.rsから削減済み
   - plugins/mod.rs が簡潔で見通しが良い

2. **モジュール分割の完了**
   - block_operations (1001行→3ファイル) ✅
   - ui_setup (977行→3ファイル) ✅
   - targeting (759行→4ファイル) ✅
   - 1000行超過のファイルがゼロに

3. **unwrap()の削減**
   - 以前72箇所→現在10箇所
   - 安全なパターン（Option/Result）への移行が進行

### 改善点

1. **command_ui.rs (826行) の肥大化**
   - コマンド解析とハンドラが混在
   - 分割推奨: command_parser.rs, command_handlers.rs

2. **main.rsにまだ残るシステム登録**
   - block_break, block_place, player_* がmain.rsに残存
   - PlayerPlugin, InteractionPlugin への移行が必要

3. **InputContextリソースの統合未完了**
   - 6つの独立したリソース (InventoryOpen, InteractingFurnace等)
   - 1つのInputContextに統合すべき

---

## Gemini 2.0 レビュー

### 良い点

1. **周辺ツールの充実 (10/10)**
   - scripts/ ディレクトリの充実
   - CI/CDパイプラインの整備
   - E2Eテストの自動化

2. **イベント駆動設計**
   - handle_setblock_event 等のEventReaderパターン
   - 毎フレームチェックではなくリアクティブ

3. **ECSパターンの適切な活用**
   - Component/System分離が明確
   - State管理が適切

### 改善点

1. **main.rsのダイエット必要** (優先度:高)
   - 現在「システムの登録所」になっている
   - ドメイン単位のPlugin化を推奨
   ```rust
   // 理想形
   App::new()
       .add_plugins(PlayerPlugin)
       .add_plugins(WorldPlugin)
       .add_plugins(InteractionPlugin)
       .add_plugins(MachinePlugin)
       .add_plugins(UiPlugin)
   ```

2. **SystemSet未活用**
   - システムがフラットに並んでいる
   - Input→Simulation→Rendering の順序制御が必要

3. **Vertical Slice Architecture推奨**
   - 現在: systems/ に全システムがフラット
   - 推奨: 機能(player/, world/)ごとにsystems.rsを配置

---

## 共通の指摘事項

| 項目 | Claude | Gemini | 優先度 |
|------|--------|--------|--------|
| main.rsのPlugin化 | ✅ | ✅ | 🔴高 |
| システム順序の明示化 | ✅ | ✅ | 🟡中 |
| モジュール構造の改善 | ✅ | ✅ | 🟡中 |
| テスト戦略の見直し | - | ✅ | 🟢低 |

---

## 見解の相違点

### 1. アーキテクチャ評価

**Claude (8/10)**: 最近のリファクタリング（block_operations, targeting分割）を評価
**Gemini (7/10)**: main.rsの肥大化を重視

**分析**: Claudeは「進捗」を、Geminiは「現状」を評価。どちらも正しい。

### 2. テストカバレッジ

**Claude**: 103件で十分（機能テスト重視）
**Gemini**: ユニットテスト比率が低い可能性を指摘

**分析**: Geminiの指摘は正しい。純粋なRust関数のテストを増やすべき。

### 3. 次のアクション

**Claude**: InputContext統合、command_ui分割
**Gemini**: PlayerPlugin作成、SystemSet導入

**分析**: 両方とも必要。Geminiの提案がより構造的。

---

## 推奨アクション（優先順）

### 🔴 高優先度

1. **PlayerPlugin作成**
   - player_move, player_look, toggle_cursor_lock をmain.rsから移動
   - 推定: 30分

2. **InteractionPlugin作成**
   - block_break, block_place をmain.rsから移動
   - 推定: 30分

### 🟡 中優先度

3. **command_ui.rs分割**
   - 826行→2-3ファイル
   - 推定: 1時間

4. **SystemSet導入**
   - GameSystemSet: Input, Simulation, Rendering
   - 推定: 1時間

### 🟢 低優先度

5. **ユニットテスト追加**
   - 純粋関数のテスト（座標計算、インベントリ操作）
   - 推定: 2時間

6. **Vertical Slice化**
   - player/, world/, machine/ への再構成
   - 推定: 3時間

---

## 結論

| レビュアー | 総合評価 | 主な強調点 |
|------------|----------|------------|
| **Claude** | 8.0/10 | リファクタリング進捗、安全性向上 |
| **Gemini** | 7.5/10 | ツール充実、main.rsダイエット必要 |
| **平均** | **7.75/10** | 良い基盤、スケーリングに課題 |

**総評**: プロジェクトは健全な状態。両AIとも「main.rsのPlugin化」を最優先と指摘。
次の機能追加前に、PlayerPlugin/InteractionPlugin作成を推奨。

---

*Generated by Claude Opus 4.5 with Gemini 2.0 comparison*
